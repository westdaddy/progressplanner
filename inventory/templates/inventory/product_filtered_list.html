{% extends 'inventory/base.html' %}
{% block title %}Products{% endblock %}

{% block content %}
<div class="section">
  <style>
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .filter-card {
      padding: 12px 16px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: none;
      flex: 0 0 15%;
      max-width: 20%;
      min-width: 245px;
    }

    .filter-section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0px;
      margin: 0px;
    }

    .filter-title {
      margin: 0 0 6px;
    }

    .filter-showing {
      margin: 0;
      color: #546e7a;
      font-weight: 600;
    }

    @media (max-width: 992px) {
      .filter-card {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }

    .filter-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .chip-set {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0;
      min-height: 32px;
    }

    .chip-set .chip__placeholder {
      background: #eceff1;
      color: #607d8b;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
    }

    .chip--selected {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2f1;
      border: 1px solid #b2dfdb;
      border-radius: 0;
    }

    .chip__remove {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0 4px;
      color: #00695c;
      font-size: 16px;
      line-height: 1;
    }

    .filter-card__toggle-symbol {
      display: inline-block;
      font-size: 22px;
      line-height: 0;
      width: 24px;
      text-align: right;
      position:relative;
      top:-6px;
      right:-16px;
    }


    .filter-card__options {
      border-top: 1px solid #eceff1;
      margin-top: 12px;
      padding-top: 12px;
    }

    .option-list {
      display: block;
      margin: 0 0 12px;
    }

    .filter-option {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 0;
      border: none;
      background: transparent;
      color: #039be5;
      font-weight: 700;
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .filter-option:hover {
      color: #0277bd;
    }

    .filter-divider {
      border-bottom: 1px solid #e0e0e0;
      margin: 12px 0 20px;
      padding-bottom: 8px;
    }

    .filter-apply-button {
      background: #f5f5f5;
      color: #455a64;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      box-shadow: none;
      font-size: 12px;
      line-height: 18px;
      text-transform: none;
      padding: 8px 8px;
      opacity: 0.5;
      transition: opacity 0.2s ease, color 0.2s ease;
      cursor: default;
    }

    .filter-apply-button.is-dirty {
      opacity: 1;
      cursor: pointer;
    }
  </style>
  {% if filter_controls %}

  <h3 class="filter-title">Products</h3>

  <div class="filter-divider"></div>

    <form method="get" class="filter-bar__form">
      <div class="filter-section-header">
        <div>
          <p class="filter-showing">Showing: {{ showing_summary }}</p>
        </div>
        <button type="submit" class="btn filter-apply-button" disabled>
          Apply
        </button>
      </div>



      <div class="filter-bar">
        {% for control in filter_controls %}
          {% with option_id="filter-options-"|add:forloop.counter %}
            <div
              class="card-panel filter-card"
              data-field-name="{{ control.field_name }}"
              data-category-label="{{ control.category_title }}"
            >
              <div class="filter-card__header">
                <div style="flex: 1; min-width: 0;">
                  <p class="grey-text text-darken-1" style="margin: 0 0 6px;" data-filter-heading>
                    {{ control.header_text }}
                  </p>
                  <div class="chip-set" data-selected-chips>
                    {% if control.selected_labels %}
                      {% for option in control.options %}
                        {% if option.checked %}
                          <span class="chip chip--selected" data-selected-value="{{ option.value }}">
                            <span class="chip__label">{{ option.label }}</span>
                            <button type="button" class="chip__remove" aria-label="Remove {{ option.label }}">&times;</button>
                          </span>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <span class="chip__placeholder" data-placeholder>None selected</span>
                    {% endif %}
                  </div>
                </div>
                <button type="button" class="btn-flat filter-card__toggle" aria-expanded="false" aria-controls="{{ option_id }}">
                  <span class="filter-card__toggle-symbol blue">+</span>
                </button>
              </div>

              <div id="{{ option_id }}" class="filter-card__options" hidden>
                <p class="grey-text text-darken-1" style="margin: 0 0 8px;">Add or remove {{ control.category_title }} options</p>
                <div class="option-list" data-available-options>
                  {% for option in control.options %}
                    {% if not option.checked %}
                      <button
                        type="button"
                        class="filter-option"
                        data-option-value="{{ option.value }}"
                        data-option-label="{{ option.label }}"
                      >
                        {{ option.label }}
                      </button>
                    {% endif %}
                  {% empty %}
                    <p class="grey-text text-darken-1" style="margin: 0;">No options available.</p>
                  {% endfor %}
                </div>
              </div>

              <div data-hidden-inputs></div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>
      <div class="filter-divider"></div>
    </form>
  {% endif %}

  <!-- STATISTICS SECTION -->
  <div class="row">
    <div class="col s12 m4">
      <div class="card-panel">
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">{{ filtered_inventory_total }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Total in stock across all matching products</p>
        <div class="filter-divider"></div>
        <h6 class="grey-text text-darken-1" style="margin-top: 0;">{{ category_breakdown_title|default:"Product Category Breakdown" }}</h6>
        {% if category_breakdown_values %}
          <canvas id="categoryBreakdownChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">{{ category_breakdown_description|default:"Inventory split by product category" }}</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No category data available.</p>
        {% endif %}
        <div class="filter-divider"></div>
        <h6 class="grey-text text-darken-1" style="margin-top: 0;">Size Breakdown</h6>
        {% if size_breakdown_values %}
          <canvas id="sizeBreakdownChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">Sizes across selected products</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No size data available.</p>
        {% endif %}
      </div>
    </div>

    <div class="col s12 m4">
      <div class="card-panel">
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">{{ sales_last_year_total }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Items sold in the last 12 months</p>
        <div class="filter-divider"></div>
        <h6 class="grey-text text-darken-1" style="margin-top: 0;">Sales by Product Category (last 12 months)</h6>
        {% if sales_category_values %}
          <canvas id="salesCategoryChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">Sales split by product category</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No sales data available.</p>
        {% endif %}
      </div>
    </div>

    <div class="col s12 m4">
      <div class="card-panel">
        <h6 class="grey-text text-darken-1">Quarterly Sales (last 12 quarters)</h6>
        {% if has_quarterly_data %}
          <canvas id="quarterlySalesChart" height="220"></canvas>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No sales recorded in this period.</p>
        {% endif %}

        <div class="filter-divider"></div>

        <h6 class="grey-text text-darken-1">Total Sold Year on Year (last 3 years)</h6>
        <ul class="collection">
          {% for entry in yearly_sales %}
            <li class="collection-item" style="border-left: 3px solid #26a69a;">
              <strong>{{ entry.label }}</strong>
              <span class="secondary-content teal-text text-darken-2">{{ entry.total }}</span>
            </li>
          {% empty %}
            <li class="collection-item">No sales data available.</li>
          {% endfor %}
        </ul>

      </div>
      <div class="card-panel" style="margin-top: 16px;">
        <h6 class="grey-text text-darken-1">Age & Gender Breakdown</h6>
        <div class="row" style="margin-bottom: 0;">
          <div class="col s12">
            <h6 class="grey-text text-darken-1" style="margin-top: 0;">Age</h6>
            {% if age_breakdown_values %}
              <canvas id="ageBreakdownChart"></canvas>
              <p class="grey-text text-darken-1" style="margin-bottom: 0;">Inventory split by age category</p>
            {% else %}
              <p class="grey-text text-darken-1" style="margin: 0;">No age data available.</p>
            {% endif %}
          </div>

          <div class="col s12" style="margin-top: 16px;">
            <h6 class="grey-text text-darken-1" style="margin-top: 0;">Gender</h6>
            {% if gender_breakdown_values %}
              <canvas id="genderBreakdownChart"></canvas>
              <p class="grey-text text-darken-1" style="margin-bottom: 0;">Inventory split by gender</p>
            {% else %}
              <p class="grey-text text-darken-1" style="margin: 0;">No gender data available.</p>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="filter-divider"></div>

  <!-- END STATISTICS SECTION -->

  <!-- PRODUCT LIST SECTION -->

  {% include 'inventory/snippets/product_scorecard.html' %}

  <!-- END PRODUCT LIST SECTION -->

</div>
{% endblock %}

{% block extrajs %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function() {
      const filterControllers = [];
      const applyButton = document.querySelector('.filter-apply-button');

      const selectionsDiffer = (a, b) => {
        if (a.length !== b.length) return true;
        return a.some((value, index) => value !== b[index]);
      };

      const rebuildApplyState = () => {
        if (!applyButton) return;

        const isDirty = filterControllers.some((controller) => {
          const current = controller.getSelection();
          const initial = controller.initialSelection || [];
          return selectionsDiffer(current, initial);
        });

        applyButton.disabled = !isDirty;
        applyButton.classList.toggle('is-dirty', isDirty);
      };

      const initFilterCard = (filterCard) => {
        const optionPanel = filterCard.querySelector('.filter-card__options');
        const toggleButtons = filterCard.querySelectorAll('.filter-card__toggle');
        const symbol = filterCard.querySelector('.filter-card__toggle-symbol');
        const selectedChips = filterCard.querySelector('[data-selected-chips]');
        const availableOptions = filterCard.querySelector('[data-available-options]');
        const hiddenInputs = filterCard.querySelector('[data-hidden-inputs]');
        const heading = filterCard.querySelector('[data-filter-heading]');
        const fieldName = filterCard.dataset.fieldName;
        const categoryLabel = filterCard.dataset.categoryLabel || '';

        const updateHeading = () => {
          if (!heading) return;
          heading.textContent = categoryLabel;
        };

        const syncHiddenInputs = () => {
          if (!hiddenInputs || !selectedChips) return;
          hiddenInputs.innerHTML = '';

          selectedChips.querySelectorAll('[data-selected-value]').forEach((chip) => {
            const value = chip.getAttribute('data-selected-value');
            if (!value) return;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = fieldName;
            input.value = value;
            hiddenInputs.appendChild(input);
          });
        };

        const ensurePlaceholder = () => {
          if (!selectedChips) return;

          const hasSelection = !!selectedChips.querySelector('[data-selected-value]');
          const placeholder = selectedChips.querySelector('[data-placeholder]');
          if (!hasSelection && !placeholder) {
            const span = document.createElement('span');
            span.className = 'chip__placeholder';
            span.setAttribute('data-placeholder', '');
            span.textContent = 'None selected';
            selectedChips.appendChild(span);
          } else if (hasSelection && placeholder) {
            placeholder.remove();
          }
        };

        const notifyChange = () => {
          rebuildApplyState();
        };

        const getSelection = () => {
          const values = [];
          if (selectedChips) {
            selectedChips.querySelectorAll('[data-selected-value]').forEach((chip) => {
              const value = chip.getAttribute('data-selected-value');
              if (value) values.push(value);
            });
          }
          return values.sort();
        };

        const removeOption = (chip) => {
          const value = chip.getAttribute('data-selected-value');
          const labelNode = chip.querySelector('.chip__label');
          const label = labelNode ? labelNode.textContent.trim() : value;

          if (availableOptions) {
            const optionBtn = document.createElement('button');
            optionBtn.type = 'button';
            optionBtn.className = 'filter-option';
            optionBtn.dataset.optionValue = value;
            optionBtn.dataset.optionLabel = label;
            optionBtn.textContent = label;
            optionBtn.addEventListener('click', () => addOption(value, label, optionBtn));
            availableOptions.appendChild(optionBtn);
          }

          chip.remove();
          ensurePlaceholder();
          syncHiddenInputs();
          updateHeading();
          notifyChange();
        };

        const addOption = (value, label, optionBtn) => {
          const chip = document.createElement('span');
          chip.className = 'chip chip--selected';
          chip.setAttribute('data-selected-value', value);

          const labelSpan = document.createElement('span');
          labelSpan.className = 'chip__label';
          labelSpan.textContent = label;

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'chip__remove';
          removeBtn.setAttribute('aria-label', `Remove ${label}`);
          removeBtn.textContent = '×';
          removeBtn.addEventListener('click', () => removeOption(chip));

          chip.appendChild(labelSpan);
          chip.appendChild(removeBtn);
          selectedChips.appendChild(chip);

          if (optionBtn) {
            optionBtn.remove();
          }

          ensurePlaceholder();
          syncHiddenInputs();
          updateHeading();
          notifyChange();
        };

        if (availableOptions) {
          availableOptions.querySelectorAll('.filter-option').forEach((btn) => {
            btn.addEventListener('click', () =>
              addOption(btn.dataset.optionValue, btn.dataset.optionLabel, btn)
            );
          });
        }

        if (selectedChips) {
          selectedChips.querySelectorAll('.chip__remove').forEach((btn) => {
            btn.addEventListener('click', (event) => {
              event.preventDefault();
              const chip = btn.closest('[data-selected-value]');
              if (chip) {
                removeOption(chip);
              }
            });
          });
        }

        ensurePlaceholder();
        syncHiddenInputs();
        updateHeading();

        const initialSelection = getSelection();

        const setExpanded = (expanded) => {
          if (!optionPanel) return;
          optionPanel.hidden = !expanded;
          filterCard.classList.toggle('filter-card--expanded', expanded);
          toggleButtons.forEach((btn) => btn.setAttribute('aria-expanded', expanded));
          if (symbol) {
            symbol.textContent = expanded ? '−' : '+';
          }
        };

        setExpanded(false);

        return {
          setExpanded,
          isExpanded: () => optionPanel && !optionPanel.hidden,
          toggleButtons,
          getSelection,
          initialSelection,
        };
      };

      document.querySelectorAll('.filter-card').forEach((card) => {
        const controller = initFilterCard(card);
        filterControllers.push(controller);
      });

      rebuildApplyState();

      const setAllExpanded = (expanded) => {
        filterControllers.forEach((controller) => controller.setExpanded(expanded));
      };

      filterControllers.forEach((controller) => {
        controller.toggleButtons.forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            const allExpanded = filterControllers.every((c) => c.isExpanded());
            const newState = !allExpanded;
            setAllExpanded(newState);
          });
        });
      });

      const labels = {{ quarterly_labels|safe }};
      const dataPoints = {{ quarterly_sales|safe }};
      const sizeLabels = {{ size_breakdown_labels|default:'[]'|safe }};
      const sizeValues = {{ size_breakdown_values|default:'[]'|safe }};
      const ageLabels = {{ age_breakdown_labels|default:'[]'|safe }};
      const ageValues = {{ age_breakdown_values|default:'[]'|safe }};
      const genderLabels = {{ gender_breakdown_labels|default:'[]'|safe }};
      const genderValues = {{ gender_breakdown_values|default:'[]'|safe }};
      const categoryLabels = {{ category_breakdown_labels|default:'[]'|safe }};
      const categoryValues = {{ category_breakdown_values|default:'[]'|safe }};
      const categoryCodes = {{ category_breakdown_codes|default:'[]'|safe }};
      const salesCategoryLabels = {{ sales_category_labels|default:'[]'|safe }};
      const salesCategoryValues = {{ sales_category_values|default:'[]'|safe }};
      const salesCategoryCodes = {{ sales_category_codes|default:'[]'|safe }};
      const selectedStyles = JSON.parse('{{ style_filters_json|default:"[]"|escapejs }}' || '[]');
      const categoryBreakdownMode = '{{ category_breakdown_mode|default:"style" }}';
      const salesCategoryMode = '{{ sales_category_mode|default:"style" }}';

      const STYLE_CATEGORY_COLORS = {
        gi: '#42a5f5',
        ng: '#ab47bc',
        ap: '#66bb6a',
        ac: '#ffa726',
      };

      const TYPE_COLORS = [
        '#42a5f5',
        '#ab47bc',
        '#66bb6a',
        '#ffa726',
        '#ef5350',
        '#26c6da',
        '#8d6e63',
        '#7e57c2',
        '#5c6bc0',
        '#26a69a',
      ];

      const categoryChartElement = document.getElementById('categoryBreakdownChart');
      if (
        categoryChartElement &&
        categoryLabels &&
        categoryLabels.length &&
        categoryValues &&
        categoryValues.length
      ) {
        const selectedStyleSet = Array.isArray(selectedStyles)
          ? new Set(selectedStyles)
          : new Set();
        const hasSelection =
          categoryBreakdownMode === 'style' && selectedStyleSet.size > 0;
        const totalCategoryUnits = categoryValues.reduce(
          (sum, value) => sum + value,
          0
        );

        const backgroundColors = categoryCodes.map((code, index) => {
          if (categoryBreakdownMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(189, 189, 189, 0.5)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        const borderColors = categoryCodes.map((code, index) => {
          if (categoryBreakdownMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(176, 190, 197, 0.8)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        new Chart(categoryChartElement.getContext('2d'), {
          type: 'pie',
          data: {
            labels: categoryLabels,
            datasets: [
              {
                data: categoryValues,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.parsed;
                    const percentage = totalCategoryUnits
                      ? ((value / totalCategoryUnits) * 100).toFixed(1)
                      : '0.0';
                    return `${context.label}: ${value} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      const salesCategoryChartElement = document.getElementById('salesCategoryChart');
      if (
        salesCategoryChartElement &&
        salesCategoryLabels &&
        salesCategoryLabels.length &&
        salesCategoryValues &&
        salesCategoryValues.length
      ) {
        const totalSalesUnits = salesCategoryValues.reduce(
          (sum, value) => sum + value,
          0
        );
        const salesMode = salesCategoryMode === 'type' ? 'type' : 'style';
        const selectedStyleSet = Array.isArray(selectedStyles)
          ? new Set(selectedStyles)
          : new Set();
        const hasSalesSelection = salesMode === 'style' && selectedStyleSet.size > 0;

        const salesBackgroundColors = (salesCategoryCodes || []).map((code, index) => {
          if (salesMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSalesSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(189, 189, 189, 0.5)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        const salesBorderColors = (salesCategoryCodes || []).map((code, index) => {
          if (salesMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSalesSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(176, 190, 197, 0.8)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        new Chart(salesCategoryChartElement.getContext('2d'), {
          type: 'pie',
          data: {
            labels: salesCategoryLabels,
            datasets: [
              {
                data: salesCategoryValues,
                backgroundColor: salesBackgroundColors,
                borderColor: salesBorderColors,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.parsed;
                    const percentage = totalSalesUnits
                      ? ((value / totalSalesUnits) * 100).toFixed(1)
                      : 0;
                    return `${context.label}: ${value} units (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      const sizeChartElement = document.getElementById('sizeBreakdownChart');

      if (sizeChartElement && sizeLabels && sizeLabels.length && sizeValues && sizeValues.length) {
        sizeChartElement.height = Math.max(sizeLabels.length * 28, 160);
        new Chart(sizeChartElement.getContext('2d'), {
          type: 'bar',
          data: {
            labels: sizeLabels,
            datasets: [{
              label: 'Units',
              data: sizeValues,
              backgroundColor: 'rgba(38, 166, 154, 0.5)',
              borderColor: '#26a69a',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.x} units`
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Units in stock'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Size'
                },
                ticks: { autoSkip: false }
              }
            }
          }
        });
      }

      const renderVerticalBarChart = (elementId, labels, values, categoryTitle) => {
        const el = document.getElementById(elementId);
        if (!el || !labels || !labels.length || !values || !values.length) return;

        new Chart(el.getContext('2d'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Units',
              data: values,
              backgroundColor: 'rgba(38, 166, 154, 0.5)',
              borderColor: '#26a69a',
              borderWidth: 1,
            }],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.y} units`,
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: categoryTitle },
              },
              y: {
                title: { display: true, text: 'Units in stock' },
                ticks: { autoSkip: false },
                beginAtZero: true,
              },
            },
          },
        });
      };

      renderVerticalBarChart('ageBreakdownChart', ageLabels, ageValues, 'Age');
      renderVerticalBarChart('genderBreakdownChart', genderLabels, genderValues, 'Gender');

      if (!dataPoints || !dataPoints.length || !document.getElementById('quarterlySalesChart')) {
        return;
      }

      const ctx = document.getElementById('quarterlySalesChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Units Sold',
            data: dataPoints,
            backgroundColor: 'rgba(38, 166, 154, 0.5)',
            borderColor: '#26a69a',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y} units`
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Quarter (Year/Month)'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number Sold'
              }
            }
          }
        }
      });
    })();
  </script>
{% endblock %}
