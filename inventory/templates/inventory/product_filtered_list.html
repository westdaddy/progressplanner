{% extends 'inventory/base.html' %}
{% block title %}Products - {{ filter_heading }}{% endblock %}

{% block content %}
<div class="section">
  <style>
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .filter-card {
      padding: 12px 16px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: none;
      flex: 0 0 15%;
      max-width: 20%;
      min-width: 245px;
    }

    @media (max-width: 992px) {
      .filter-card {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }

    .filter-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .chip-set {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0;
      min-height: 32px;
    }

    .chip-set .chip__placeholder {
      background: #eceff1;
      color: #607d8b;
      padding: 6px 10px;
      border-radius: 16px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
    }

    .chip--selected {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2f1;
      border: 1px solid #b2dfdb;
      border-radius: 0;
    }

    .chip__remove {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0 4px;
      color: #00695c;
      font-size: 16px;
      line-height: 1;
    }

    .filter-card__toggle {
      padding: 0;
      border: none;
      background: transparent;
      color: #546e7a;
      box-shadow: none;
    }

    .filter-card__toggle-symbol {
      display: inline-block;
      font-size: 18px;
      line-height: 1;
      width: 24px;
      text-align: right;
    }

    .filter-card__options {
      border-top: 1px solid #eceff1;
      margin-top: 12px;
      padding-top: 12px;
    }

    .option-list {
      display: block;
      margin: 0 0 12px;
    }

    .filter-option {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 0;
      border: none;
      background: transparent;
      color: #039be5;
      font-weight: 700;
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .filter-option:hover {
      color: #0277bd;
    }

    .filter-bar__footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }
  </style>
  <h3>{{ filter_heading }}</h3>
  {% if filter_description %}
    <p class="grey-text text-darken-1">{{ filter_description }}</p>
  {% endif %}

  {% if filter_controls %}
    <form method="get" class="filter-bar__form">
      <div class="filter-bar">
        {% for control in filter_controls %}
          {% with option_id="filter-options-"|add:forloop.counter %}
            <div
              class="card-panel filter-card"
              data-field-name="{{ control.field_name }}"
              data-category-label="{{ control.category_title }}"
            >
              <div class="filter-card__header">
                <div style="flex: 1; min-width: 0;">
                  <p class="grey-text text-darken-1" style="margin: 0 0 6px;" data-filter-heading>
                    {{ control.header_text }}
                  </p>
                  <div class="chip-set" data-selected-chips>
                    {% if control.selected_labels %}
                      {% for option in control.options %}
                        {% if option.checked %}
                          <span class="chip chip--selected" data-selected-value="{{ option.value }}">
                            <span class="chip__label">{{ option.label }}</span>
                            <button type="button" class="chip__remove" aria-label="Remove {{ option.label }}">&times;</button>
                          </span>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <span class="chip__placeholder" data-placeholder>None selected</span>
                    {% endif %}
                  </div>
                </div>
                <button type="button" class="btn-flat filter-card__toggle" aria-expanded="false" aria-controls="{{ option_id }}">
                  <span class="filter-card__toggle-symbol">+</span>
                </button>
              </div>

              <div id="{{ option_id }}" class="filter-card__options" hidden>
                <p class="grey-text text-darken-1" style="margin: 0 0 8px;">Add or remove {{ control.category_title }} options</p>
                <div class="option-list" data-available-options>
                  {% for option in control.options %}
                    {% if not option.checked %}
                      <button
                        type="button"
                        class="filter-option"
                        data-option-value="{{ option.value }}"
                        data-option-label="{{ option.label }}"
                      >
                        {{ option.label }}
                      </button>
                    {% endif %}
                  {% empty %}
                    <p class="grey-text text-darken-1" style="margin: 0;">No options available.</p>
                  {% endfor %}
                </div>
              </div>

              <div data-hidden-inputs></div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>

      <div class="filter-bar__footer">
        <button type="submit" class="btn waves-effect waves-light">
          Apply
        </button>
      </div>
    </form>
  {% endif %}

  <div class="row">
    <div class="col s12 m4">
      <div class="card-panel">
        <h6 class="grey-text text-darken-1">Total In Stock</h6>
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">{{ filtered_inventory_total }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Units across all matching products</p>
      </div>
    </div>

    <div class="col s12 m4">
      <div class="card-panel">
        <h6 class="grey-text text-darken-1">Total Sold by Year (last 3 years)</h6>
        <ul class="collection">
          {% for entry in yearly_sales %}
            <li class="collection-item" style="border-left: 3px solid #26a69a;">
              <strong>{{ entry.label }}</strong>
              <span class="secondary-content teal-text text-darken-2">{{ entry.total }}</span>
            </li>
          {% empty %}
            <li class="collection-item">No sales data available.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="col s12 m4">
      <div class="card-panel">
        <h6 class="grey-text text-darken-1">Quarterly Sales (last 12 quarters)</h6>
        {% if has_quarterly_data %}
          <canvas id="quarterlySalesChart" height="220"></canvas>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No sales recorded in this period.</p>
        {% endif %}
      </div>
    </div>
  </div>

  {% include 'inventory/snippets/product_card_default.html' %}
</div>
{% endblock %}

{% block extrajs %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function() {
      const initFilterCard = (filterCard) => {
        const optionPanel = filterCard.querySelector('.filter-card__options');
        const toggleButtons = filterCard.querySelectorAll('.filter-card__toggle');
        const symbol = filterCard.querySelector('.filter-card__toggle-symbol');
        const selectedChips = filterCard.querySelector('[data-selected-chips]');
        const availableOptions = filterCard.querySelector('[data-available-options]');
        const hiddenInputs = filterCard.querySelector('[data-hidden-inputs]');
        const heading = filterCard.querySelector('[data-filter-heading]');
        const fieldName = filterCard.dataset.fieldName;
        const categoryLabel = filterCard.dataset.categoryLabel || '';

        const updateHeading = () => {
          if (!heading) return;
          heading.textContent = categoryLabel;
        };

        const syncHiddenInputs = () => {
          if (!hiddenInputs || !selectedChips) return;
          hiddenInputs.innerHTML = '';

          selectedChips.querySelectorAll('[data-selected-value]').forEach((chip) => {
            const value = chip.getAttribute('data-selected-value');
            if (!value) return;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = fieldName;
            input.value = value;
            hiddenInputs.appendChild(input);
          });
        };

        const ensurePlaceholder = () => {
          if (!selectedChips) return;

          const hasSelection = !!selectedChips.querySelector('[data-selected-value]');
          const placeholder = selectedChips.querySelector('[data-placeholder]');
          if (!hasSelection && !placeholder) {
            const span = document.createElement('span');
            span.className = 'chip__placeholder';
            span.setAttribute('data-placeholder', '');
            span.textContent = 'None selected';
            selectedChips.appendChild(span);
          } else if (hasSelection && placeholder) {
            placeholder.remove();
          }
        };

        const removeOption = (chip) => {
          const value = chip.getAttribute('data-selected-value');
          const labelNode = chip.querySelector('.chip__label');
          const label = labelNode ? labelNode.textContent.trim() : value;

          if (availableOptions) {
            const optionBtn = document.createElement('button');
            optionBtn.type = 'button';
            optionBtn.className = 'filter-option';
            optionBtn.dataset.optionValue = value;
            optionBtn.dataset.optionLabel = label;
            optionBtn.textContent = label;
            optionBtn.addEventListener('click', () => addOption(value, label, optionBtn));
            availableOptions.appendChild(optionBtn);
          }

          chip.remove();
          ensurePlaceholder();
          syncHiddenInputs();
          updateHeading();
        };

        const addOption = (value, label, optionBtn) => {
          const chip = document.createElement('span');
          chip.className = 'chip chip--selected';
          chip.setAttribute('data-selected-value', value);

          const labelSpan = document.createElement('span');
          labelSpan.className = 'chip__label';
          labelSpan.textContent = label;

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'chip__remove';
          removeBtn.setAttribute('aria-label', `Remove ${label}`);
          removeBtn.textContent = '×';
          removeBtn.addEventListener('click', () => removeOption(chip));

          chip.appendChild(labelSpan);
          chip.appendChild(removeBtn);
          selectedChips.appendChild(chip);

          if (optionBtn) {
            optionBtn.remove();
          }

          ensurePlaceholder();
          syncHiddenInputs();
          updateHeading();
        };

        if (availableOptions) {
          availableOptions.querySelectorAll('.filter-option').forEach((btn) => {
            btn.addEventListener('click', () =>
              addOption(btn.dataset.optionValue, btn.dataset.optionLabel, btn)
            );
          });
        }

        if (selectedChips) {
          selectedChips.querySelectorAll('.chip__remove').forEach((btn) => {
            btn.addEventListener('click', (event) => {
              event.preventDefault();
              const chip = btn.closest('[data-selected-value]');
              if (chip) {
                removeOption(chip);
              }
            });
          });
        }

        ensurePlaceholder();
        syncHiddenInputs();
        updateHeading();

        const setExpanded = (expanded) => {
          if (!optionPanel) return;
          optionPanel.hidden = !expanded;
          filterCard.classList.toggle('filter-card--expanded', expanded);
          toggleButtons.forEach((btn) => btn.setAttribute('aria-expanded', expanded));
          if (symbol) {
            symbol.textContent = expanded ? '−' : '+';
          }
        };

        setExpanded(false);

        return {
          setExpanded,
          isExpanded: () => optionPanel && !optionPanel.hidden,
          toggleButtons,
        };
      };

      const filterControllers = [];

      document.querySelectorAll('.filter-card').forEach((card) => {
        const controller = initFilterCard(card);
        filterControllers.push(controller);
      });

      const setAllExpanded = (expanded) => {
        filterControllers.forEach((controller) => controller.setExpanded(expanded));
      };

      filterControllers.forEach((controller) => {
        controller.toggleButtons.forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            const allExpanded = filterControllers.every((c) => c.isExpanded());
            const newState = !allExpanded;
            setAllExpanded(newState);
          });
        });
      });

      const labels = {{ quarterly_labels|safe }};
      const dataPoints = {{ quarterly_sales|safe }};

      if (!dataPoints || !dataPoints.length || !document.getElementById('quarterlySalesChart')) {
        return;
      }

      const ctx = document.getElementById('quarterlySalesChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Units Sold',
            data: dataPoints,
            backgroundColor: 'rgba(38, 166, 154, 0.5)',
            borderColor: '#26a69a',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y} units`
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Quarter (Year/Month)'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number Sold'
              }
            }
          }
        }
      });
    })();
  </script>
{% endblock %}
