{% extends 'inventory/base.html' %}
{% block title %}Products{% endblock %}

{% block content %}
<div class="section">
  <style>
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .filter-card {
      padding: 12px 16px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: none;
      flex: 0 0 15%;
      max-width: 20%;
      min-width: 245px;
    }

    .filter-section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0px;
      margin: 0px;
    }

    .filter-title {
      margin: 15px 0 6px;
    }

    .filter-showing {
      margin: 0;
      color: #546e7a;
      font-weight: 600;
    }

    @media (max-width: 992px) {
      .filter-card {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }

    .filter-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .chip-set {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0;
      min-height: 32px;
    }

    .chip-set .chip__placeholder {
      background: #eceff1;
      color: #607d8b;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
    }

    .chip--selected {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2f1;
      border: 1px solid #b2dfdb;
      border-radius: 0;
    }

    .chip__remove {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0 4px;
      color: #00695c;
      font-size: 16px;
      line-height: 1;
    }

    .filter-card__toggle-symbol {
      display: inline-block;
      font-size: 22px;
      line-height: 0;
      width: 24px;
      text-align: right;
      position:relative;
      top:-6px;
      right:-16px;
    }


    .filter-card__options {
      border-top: 1px solid #eceff1;
      margin-top: 12px;
      padding-top: 12px;
    }

    .option-list {
      display: block;
      margin: 0 0 12px;
    }

    .filter-option {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 0;
      border: none;
      background: transparent;
      color: #039be5;
      font-weight: 700;
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .filter-option:hover {
      color: #0277bd;
    }

    .filter-divider {
      border-bottom: 1px solid #e0e0e0;
      margin: 12px 0 20px;
      padding-bottom: 8px;
    }

    .filter-apply-button {
      background: #f5f5f5;
      color: #455a64;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      box-shadow: none;
      font-size: 12px;
      line-height: 18px;
      text-transform: none;
      padding: 8px 8px;
      opacity: 0.5;
      transition: opacity 0.2s ease, color 0.2s ease;
      cursor: default;
    }

    .filter-apply-button.is-dirty {
      opacity: 1;
      cursor: pointer;
    }

    .filter-card--tiered .tiered-section {
      margin-bottom: 12px;
    }

    .filter-card--tiered .tiered-section[hidden] {
      display: none;
    }

    .filter-card--tiered .tiered-section__title {
      margin: 0 0 6px;
      font-weight: 600;
      color: #455a64;
    }

    .filter-card--tiered .filter-option {
      display: inline-flex;
      width: auto;
      margin-right: 10px;
    }
  </style>
  {% if filter_controls %}

  <h3 class="filter-title">Products</h3>

  <div class="filter-divider"></div>

    <form method="get" class="filter-bar__form">
      <div class="filter-section-header">
        <div>
          <p class="filter-showing">Showing: {{ showing_summary }}</p>
        </div>
        <button type="submit" class="btn filter-apply-button" disabled>
          Apply
        </button>
      </div>



      <div class="filter-bar">
        {% if category_filter %}
          <div
            class="card-panel filter-card filter-card--tiered"
            data-category-filter-card
            data-style-field="style_filter"
            data-type-field="type_filter"
            data-subtype-field="subtype_filter"
          >
            <div class="filter-card__header">
              <div style="flex: 1; min-width: 0;">
                <p class="grey-text text-darken-1" style="margin: 0 0 6px;">Product Category</p>
                <div class="chip-set" data-selected-chips>
                  <span class="chip__placeholder" data-placeholder>None selected</span>
                </div>
              </div>
              <button type="button" class="btn-flat filter-card__toggle" aria-expanded="false">
                <span class="filter-card__toggle-symbol blue">+</span>
              </button>
            </div>

            <div class="filter-card__options" hidden data-tiered-options>
              <div class="tiered-section" data-style-section>
                <p class="tiered-section__title">Product Category</p>
                <div class="option-list" data-style-options></div>
              </div>

              <div class="tiered-section" data-type-section hidden>
                <p class="tiered-section__title">Product Subcategory</p>
                <div class="option-list" data-type-options></div>
              </div>

              <div class="tiered-section" data-subtype-section hidden>
                <p class="tiered-section__title">Product Subtype</p>
                <div class="option-list" data-subtype-options></div>
              </div>
            </div>

            <div data-hidden-inputs></div>
          </div>
        {% endif %}

        {% for control in filter_controls %}
          {% with option_id="filter-options-"|add:forloop.counter %}
            <div
              class="card-panel filter-card"
              data-field-name="{{ control.field_name }}"
              data-category-label="{{ control.category_title }}"
            >
              <div class="filter-card__header">
                <div style="flex: 1; min-width: 0;">
                  <p class="grey-text text-darken-1" style="margin: 0 0 6px;" data-filter-heading>
                    {{ control.header_text }}
                  </p>
                  <div class="chip-set" data-selected-chips>
                    {% if control.selected_labels %}
                      {% for option in control.options %}
                        {% if option.checked %}
                          <span class="chip chip--selected" data-selected-value="{{ option.value }}">
                            <span class="chip__label">{{ option.label }}</span>
                            <button type="button" class="chip__remove" aria-label="Remove {{ option.label }}">&times;</button>
                          </span>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <span class="chip__placeholder" data-placeholder>None selected</span>
                    {% endif %}
                  </div>
                </div>
                <button type="button" class="btn-flat filter-card__toggle" aria-expanded="false" aria-controls="{{ option_id }}">
                  <span class="filter-card__toggle-symbol blue">+</span>
                </button>
              </div>

              <div id="{{ option_id }}" class="filter-card__options" hidden>
                <p class="grey-text text-darken-1" style="margin: 0 0 8px;">Add or remove {{ control.category_title }} options</p>
                <div class="option-list" data-available-options>
                  {% for option in control.options %}
                    {% if not option.checked %}
                      <button
                        type="button"
                        class="filter-option"
                        data-option-value="{{ option.value }}"
                        data-option-label="{{ option.label }}"
                      >
                        {{ option.label }}
                      </button>
                    {% endif %}
                  {% empty %}
                    <p class="grey-text text-darken-1" style="margin: 0;">No options available.</p>
                  {% endfor %}
                </div>
              </div>

              <div data-hidden-inputs></div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>
      <div class="filter-divider"></div>
    </form>
  {% endif %}

  {% if category_filter %}
    {{ category_filter.styles|json_script:"category-style-options" }}
    {{ category_filter.types|json_script:"category-type-options" }}
    {{ category_filter.subtypes|json_script:"category-subtype-options" }}
    {{ category_filter.type_map|json_script:"category-type-map" }}
    {{ category_filter.subtype_map|json_script:"category-subtype-map" }}
  {% endif %}

  <!-- STATISTICS SECTION -->
  <div class="row">
    <div class="col s12 m4">
      <div class="card-panel">
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">{{ filtered_inventory_total }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Total in stock across all matching products</p>
        <div class="filter-divider"></div>
        {% if category_breakdown_values %}
          <canvas id="categoryBreakdownChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">{{ category_breakdown_description|default:"Inventory split by product category" }}</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No category data available.</p>
        {% endif %}
      </div>

      <div class="card-panel">
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">¥{{ inventory_value_total|floatformat:2 }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Estimated value of stock (RMB)</p>
        <div class="filter-divider"></div>
        {% if inventory_value_category_values %}
          <canvas id="inventoryValueChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">Inventory value split by product category</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No value data available.</p>
        {% endif %}
      </div>

    </div>

    <div class="col s12 m4">
      <div class="card-panel">
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">{{ sales_last_year_total }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Items sold in the last 12 months</p>
        <div class="filter-divider"></div>
        {% if sales_category_values %}
          <canvas id="salesCategoryChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">Sales split by product category</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No sales data available.</p>
        {% endif %}
      </div>

      <div class="card-panel">
        <h4 class="teal-text text-darken-2" style="margin-top: 0;">¥{{ sales_last_year_value_total|floatformat:2 }}</h4>
        <p class="grey-text text-darken-1" style="margin-bottom: 0;">Sales value in the last 12 months (RMB)</p>
        <div class="filter-divider"></div>
        {% if sales_value_category_values %}
          <canvas id="salesValueChart"></canvas>
          <p class="grey-text text-darken-1" style="margin-bottom: 0;">Sales value split by product category</p>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No sales value data available.</p>
        {% endif %}
      </div>

    </div>

    <div class="col s12 m4">
      <div class="card-panel">
        <h6 class="grey-text text-darken-1">Quarterly Sales (last 12 quarters)</h6>
        {% if has_quarterly_data %}
          <canvas id="quarterlySalesChart" height="220"></canvas>
        {% else %}
          <p class="grey-text text-darken-1" style="margin: 0;">No sales recorded in this period.</p>
        {% endif %}

        <div class="filter-divider"></div>

        <h6 class="grey-text text-darken-1">Total Sold Year on Year (last 3 years)</h6>
        <ul class="collection">
          {% for entry in yearly_sales %}
            <li class="collection-item" style="border-left: 3px solid #26a69a;">
              <strong>{{ entry.label }}</strong>
              <span class="secondary-content teal-text text-darken-2">{{ entry.total }}</span>
            </li>
          {% empty %}
            <li class="collection-item">No sales data available.</li>
          {% endfor %}
        </ul>

      </div>

      <div class="card-panel" style="margin-top: 16px;">
        <h6 class="grey-text text-darken-1">Age & Gender Breakdown</h6>
        <div class="row" style="margin-bottom: 0;">
          <div class="col s12">
            <h6 class="grey-text text-darken-1" style="margin-top: 0;">Age</h6>
            {% if age_breakdown_values %}
              <canvas id="ageBreakdownChart"></canvas>
              <p class="grey-text text-darken-1" style="margin-bottom: 0;">Inventory split by age category</p>
            {% else %}
              <p class="grey-text text-darken-1" style="margin: 0;">No age data available.</p>
            {% endif %}
          </div>



          <div class="col s12" style="margin-top: 16px;">
            <h6 class="grey-text text-darken-1" style="margin-top: 0;">Gender</h6>
            {% if gender_breakdown_values %}
              <canvas id="genderBreakdownChart"></canvas>
              <p class="grey-text text-darken-1" style="margin-bottom: 0;">Inventory split by gender</p>
            {% else %}
              <p class="grey-text text-darken-1" style="margin: 0;">No gender data available.</p>
            {% endif %}
          </div>

          <div class="col s12" style="margin-top: 16px;">
            <h6 class="grey-text text-darken-1" style="margin-top: 0;">Size Breakdown</h6>
            {% if size_breakdown_values %}
              <canvas id="sizeBreakdownChart"></canvas>
              <p class="grey-text text-darken-1" style="margin-bottom: 0;">Sizes across selected products</p>
            {% else %}
              <p class="grey-text text-darken-1" style="margin: 0;">No size data available.</p>
            {% endif %}
          </div>

        </div>



      </div>
    </div>
  </div>

  <div class="filter-divider"></div>

  <!-- END STATISTICS SECTION -->

  <!-- PRODUCT LIST SECTION -->

  {% include 'inventory/snippets/product_scorecard.html' %}

  <!-- END PRODUCT LIST SECTION -->

</div>
{% endblock %}

{% block extrajs %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function() {
      const filterControllers = [];
      const applyButton = document.querySelector('.filter-apply-button');

      const selectionsDiffer = (a, b) => {
        if (a.length !== b.length) return true;
        return a.some((value, index) => value !== b[index]);
      };

      const rebuildApplyState = () => {
        if (!applyButton) return;

        const isDirty = filterControllers.some((controller) => {
          const current = controller.getSelection();
          const initial = controller.initialSelection || [];
          return selectionsDiffer(current, initial);
        });

        applyButton.disabled = !isDirty;
        applyButton.classList.toggle('is-dirty', isDirty);
      };

      const parseJsonScript = (id, fallback = []) => {
        const el = document.getElementById(id);
        if (!el) return fallback;
        try {
          return JSON.parse(el.textContent);
        } catch (e) {
          return fallback;
        }
      };

      const initCategoryFilterCard = (card) => {
        if (!card) return null;

        const selectedChips = card.querySelector('[data-selected-chips]');
        const optionsPanel = card.querySelector('[data-tiered-options]');
        const toggleButtons = card.querySelectorAll('.filter-card__toggle');
        const symbol = card.querySelector('.filter-card__toggle-symbol');
        const hiddenInputs = card.querySelector('[data-hidden-inputs]');
        const styleOptionsContainer = card.querySelector('[data-style-options]');
        const typeOptionsContainer = card.querySelector('[data-type-options]');
        const subtypeOptionsContainer = card.querySelector('[data-subtype-options]');
        const typeSection = card.querySelector('[data-type-section]');
        const subtypeSection = card.querySelector('[data-subtype-section]');

        const styleFieldName = card.dataset.styleField;
        const typeFieldName = card.dataset.typeField;
        const subtypeFieldName = card.dataset.subtypeField;

        const styleOptions = parseJsonScript('category-style-options', []);
        const typeOptions = parseJsonScript('category-type-options', []);
        const subtypeOptions = parseJsonScript('category-subtype-options', []);
        const typeMap = parseJsonScript('category-type-map', {});
        const subtypeMap = parseJsonScript('category-subtype-map', {});

        const styleLabelMap = Object.fromEntries(
          (styleOptions || []).map((opt) => [opt.value, opt.label])
        );
        const typeLabelMap = Object.fromEntries(
          (typeOptions || []).map((opt) => [opt.value, opt.label])
        );
        const subtypeLabelMap = Object.fromEntries(
          (subtypeOptions || []).map((opt) => [opt.value, opt.label])
        );

        const notifyChange = () => {
          rebuildApplyState();
        };

        let selectedStyles = new Set(
          (styleOptions || [])
            .filter((opt) => opt.checked)
            .map((opt) => String(opt.value))
        );
        let selectedTypes = new Set(
          (typeOptions || [])
            .filter((opt) => opt.checked)
            .map((opt) => String(opt.value))
        );
        let selectedSubtypes = new Set(
          (subtypeOptions || [])
            .filter((opt) => opt.checked)
            .map((opt) => String(opt.value))
        );

        const allowedTypes = () => {
          if (!selectedStyles.size) return new Set();
          const allowed = new Set();
          selectedStyles.forEach((style) => {
            (typeMap[style] || []).forEach(([code]) => allowed.add(String(code)));
          });
          return allowed;
        };

        const allowedSubtypes = () => {
          if (!selectedTypes.size) return new Set();
          const allowed = new Set();
          selectedTypes.forEach((type) => {
            (subtypeMap[type] || []).forEach(([code]) => allowed.add(String(code)));
          });
          return allowed;
        };

        const ensureHierarchyIntegrity = () => {
          const allowedTypeCodes = allowedTypes();
          selectedTypes = new Set(
            Array.from(selectedTypes).filter((code) => allowedTypeCodes.has(code))
          );

          const allowedSubtypeCodes = allowedSubtypes();
          selectedSubtypes = new Set(
            Array.from(selectedSubtypes).filter((code) => allowedSubtypeCodes.has(code))
          );
        };

        const syncHiddenInputs = () => {
          if (!hiddenInputs) return;
          hiddenInputs.innerHTML = '';

          const createInputs = (fieldName, values) => {
            values.forEach((val) => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = fieldName;
              input.value = val;
              hiddenInputs.appendChild(input);
            });
          };

          createInputs(styleFieldName, Array.from(selectedStyles));
          createInputs(typeFieldName, Array.from(selectedTypes));
          createInputs(subtypeFieldName, Array.from(selectedSubtypes));
        };

        const renderChips = () => {
          if (!selectedChips) return;
          selectedChips.innerHTML = '';

          const addChip = (value, label, onRemove) => {
            const chip = document.createElement('span');
            chip.className = 'chip chip--selected';
            chip.dataset.selectedValue = value;

            const labelSpan = document.createElement('span');
            labelSpan.className = 'chip__label';
            labelSpan.textContent = label;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'chip__remove';
            removeBtn.setAttribute('aria-label', `Remove ${label}`);
            removeBtn.textContent = '×';
            removeBtn.addEventListener('click', onRemove);

            chip.appendChild(labelSpan);
            chip.appendChild(removeBtn);
            selectedChips.appendChild(chip);
          };

          selectedStyles.forEach((code) => {
            const label = styleLabelMap[code] || code;
            addChip(code, label, () => {
              selectedStyles.delete(code);
              ensureHierarchyIntegrity();
              renderAll();
            });
          });

          selectedTypes.forEach((code) => {
            const label = typeLabelMap[code] || code;
            addChip(code, label, () => {
              selectedTypes.delete(code);
              ensureHierarchyIntegrity();
              renderAll();
            });
          });

          selectedSubtypes.forEach((code) => {
            const label = subtypeLabelMap[code] || code;
            addChip(code, label, () => {
              selectedSubtypes.delete(code);
              ensureHierarchyIntegrity();
              renderAll();
            });
          });

          if (
            !selectedStyles.size &&
            !selectedTypes.size &&
            !selectedSubtypes.size
          ) {
            const placeholder = document.createElement('span');
            placeholder.className = 'chip__placeholder';
            placeholder.setAttribute('data-placeholder', '');
            placeholder.textContent = 'None selected';
            selectedChips.appendChild(placeholder);
          }
        };

        const renderButtons = (container, options, selectedSet, allowedSet, onSelect) => {
          if (!container) return;
          container.innerHTML = '';
          options
            .filter((opt) => !selectedSet.has(String(opt.value)))
            .filter((opt) => !allowedSet || allowedSet.has(String(opt.value)))
            .forEach((opt) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'filter-option';
              btn.dataset.optionValue = opt.value;
              btn.textContent = opt.label;
              btn.addEventListener('click', () => onSelect(String(opt.value)));
              container.appendChild(btn);
            });
        };

        const renderStyleOptions = () => {
          renderButtons(
            styleOptionsContainer,
            styleOptions || [],
            selectedStyles,
            null,
            (value) => {
              selectedStyles.add(value);
              renderAll();
            }
          );
        };

        const renderTypeOptions = () => {
          const allowedTypeCodes = allowedTypes();
          if (typeSection) {
            typeSection.hidden = !allowedTypeCodes.size;
          }
          renderButtons(
            typeOptionsContainer,
            typeOptions || [],
            selectedTypes,
            allowedTypeCodes,
            (value) => {
              selectedTypes.add(value);
              renderAll();
            }
          );
        };

        const renderSubtypeOptions = () => {
          const allowedSubtypeCodes = allowedSubtypes();
          if (subtypeSection) {
            subtypeSection.hidden = !allowedSubtypeCodes.size;
          }
          renderButtons(
            subtypeOptionsContainer,
            subtypeOptions || [],
            selectedSubtypes,
            allowedSubtypeCodes,
            (value) => {
              selectedSubtypes.add(value);
              renderAll();
            }
          );
        };

        const getSelection = () => {
          return [
            ...Array.from(selectedStyles).sort().map((value) => `style:${value}`),
            ...Array.from(selectedTypes).sort().map((value) => `type:${value}`),
            ...Array.from(selectedSubtypes)
              .sort()
              .map((value) => `subtype:${value}`),
          ];
        };

        const renderAll = () => {
          ensureHierarchyIntegrity();
          renderChips();
          renderStyleOptions();
          renderTypeOptions();
          renderSubtypeOptions();
          syncHiddenInputs();
          notifyChange();
        };

        const setExpanded = (expanded) => {
          if (!optionsPanel) return;
          optionsPanel.hidden = !expanded;
          card.classList.toggle('filter-card--expanded', expanded);
          toggleButtons.forEach((btn) => btn.setAttribute('aria-expanded', expanded));
          if (symbol) {
            symbol.textContent = expanded ? '−' : '+';
          }
        };

        ensureHierarchyIntegrity();
        const initialSelection = getSelection();
        renderAll();
        setExpanded(false);

        return {
          setExpanded,
          isExpanded: () => optionsPanel && !optionsPanel.hidden,
          toggleButtons,
          getSelection,
          initialSelection,
        };
      };

      const initFilterCard = (filterCard) => {
        const optionPanel = filterCard.querySelector('.filter-card__options');
        const toggleButtons = filterCard.querySelectorAll('.filter-card__toggle');
        const symbol = filterCard.querySelector('.filter-card__toggle-symbol');
        const selectedChips = filterCard.querySelector('[data-selected-chips]');
        const availableOptions = filterCard.querySelector('[data-available-options]');
        const hiddenInputs = filterCard.querySelector('[data-hidden-inputs]');
        const heading = filterCard.querySelector('[data-filter-heading]');
        const fieldName = filterCard.dataset.fieldName;
        const categoryLabel = filterCard.dataset.categoryLabel || '';

        const updateHeading = () => {
          if (!heading) return;
          heading.textContent = categoryLabel;
        };

        const syncHiddenInputs = () => {
          if (!hiddenInputs || !selectedChips) return;
          hiddenInputs.innerHTML = '';

          selectedChips.querySelectorAll('[data-selected-value]').forEach((chip) => {
            const value = chip.getAttribute('data-selected-value');
            if (!value) return;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = fieldName;
            input.value = value;
            hiddenInputs.appendChild(input);
          });
        };

        const ensurePlaceholder = () => {
          if (!selectedChips) return;

          const hasSelection = !!selectedChips.querySelector('[data-selected-value]');
          const placeholder = selectedChips.querySelector('[data-placeholder]');
          if (!hasSelection && !placeholder) {
            const span = document.createElement('span');
            span.className = 'chip__placeholder';
            span.setAttribute('data-placeholder', '');
            span.textContent = 'None selected';
            selectedChips.appendChild(span);
          } else if (hasSelection && placeholder) {
            placeholder.remove();
          }
        };

        const notifyChange = () => {
          rebuildApplyState();
        };

        const getSelection = () => {
          const values = [];
          if (selectedChips) {
            selectedChips.querySelectorAll('[data-selected-value]').forEach((chip) => {
              const value = chip.getAttribute('data-selected-value');
              if (value) values.push(value);
            });
          }
          return values.sort();
        };

        const removeOption = (chip) => {
          const value = chip.getAttribute('data-selected-value');
          const labelNode = chip.querySelector('.chip__label');
          const label = labelNode ? labelNode.textContent.trim() : value;

          if (availableOptions) {
            const optionBtn = document.createElement('button');
            optionBtn.type = 'button';
            optionBtn.className = 'filter-option';
            optionBtn.dataset.optionValue = value;
            optionBtn.dataset.optionLabel = label;
            optionBtn.textContent = label;
            optionBtn.addEventListener('click', () => addOption(value, label, optionBtn));
            availableOptions.appendChild(optionBtn);
          }

          chip.remove();
          ensurePlaceholder();
          syncHiddenInputs();
          updateHeading();
          notifyChange();
        };

        const addOption = (value, label, optionBtn) => {
          const chip = document.createElement('span');
          chip.className = 'chip chip--selected';
          chip.setAttribute('data-selected-value', value);

          const labelSpan = document.createElement('span');
          labelSpan.className = 'chip__label';
          labelSpan.textContent = label;

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'chip__remove';
          removeBtn.setAttribute('aria-label', `Remove ${label}`);
          removeBtn.textContent = '×';
          removeBtn.addEventListener('click', () => removeOption(chip));

          chip.appendChild(labelSpan);
          chip.appendChild(removeBtn);
          selectedChips.appendChild(chip);

          if (optionBtn) {
            optionBtn.remove();
          }

          ensurePlaceholder();
          syncHiddenInputs();
          updateHeading();
          notifyChange();
        };

        if (availableOptions) {
          availableOptions.querySelectorAll('.filter-option').forEach((btn) => {
            btn.addEventListener('click', () =>
              addOption(btn.dataset.optionValue, btn.dataset.optionLabel, btn)
            );
          });
        }

        if (selectedChips) {
          selectedChips.querySelectorAll('.chip__remove').forEach((btn) => {
            btn.addEventListener('click', (event) => {
              event.preventDefault();
              const chip = btn.closest('[data-selected-value]');
              if (chip) {
                removeOption(chip);
              }
            });
          });
        }

        ensurePlaceholder();
        syncHiddenInputs();
        updateHeading();

        const initialSelection = getSelection();

        const setExpanded = (expanded) => {
          if (!optionPanel) return;
          optionPanel.hidden = !expanded;
          filterCard.classList.toggle('filter-card--expanded', expanded);
          toggleButtons.forEach((btn) => btn.setAttribute('aria-expanded', expanded));
          if (symbol) {
            symbol.textContent = expanded ? '−' : '+';
          }
        };

        setExpanded(false);

        return {
          setExpanded,
          isExpanded: () => optionPanel && !optionPanel.hidden,
          toggleButtons,
          getSelection,
          initialSelection,
        };
      };

      const categoryCard = document.querySelector('[data-category-filter-card]');
      if (categoryCard) {
        const categoryController = initCategoryFilterCard(categoryCard);
        if (categoryController) {
          filterControllers.push(categoryController);
        }
      }

      document.querySelectorAll('.filter-card').forEach((card) => {
        if (card.hasAttribute('data-category-filter-card')) return;
        const controller = initFilterCard(card);
        filterControllers.push(controller);
      });

      rebuildApplyState();

      const setAllExpanded = (expanded) => {
        filterControllers.forEach((controller) => controller.setExpanded(expanded));
      };

      filterControllers.forEach((controller) => {
        controller.toggleButtons.forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            const allExpanded = filterControllers.every((c) => c.isExpanded());
            const newState = !allExpanded;
            setAllExpanded(newState);
          });
        });
      });

      const labels = {{ quarterly_labels|safe }};
      const dataPoints = {{ quarterly_sales|safe }};
      const sizeLabels = {{ size_breakdown_labels|default:'[]'|safe }};
      const sizeValues = {{ size_breakdown_values|default:'[]'|safe }};
      const ageLabels = {{ age_breakdown_labels|default:'[]'|safe }};
      const ageValues = {{ age_breakdown_values|default:'[]'|safe }};
      const genderLabels = {{ gender_breakdown_labels|default:'[]'|safe }};
      const genderValues = {{ gender_breakdown_values|default:'[]'|safe }};
      const categoryLabels = {{ category_breakdown_labels|default:'[]'|safe }};
      const categoryValues = {{ category_breakdown_values|default:'[]'|safe }};
      const categoryCodes = {{ category_breakdown_codes|default:'[]'|safe }};
      const salesCategoryLabels = {{ sales_category_labels|default:'[]'|safe }};
      const salesCategoryValues = {{ sales_category_values|default:'[]'|safe }};
      const salesCategoryCodes = {{ sales_category_codes|default:'[]'|safe }};
      const selectedStyles = JSON.parse('{{ style_filters_json|default:"[]"|escapejs }}' || '[]');
      const categoryBreakdownMode = '{{ category_breakdown_mode|default:"style" }}';
      const salesCategoryMode = '{{ sales_category_mode|default:"style" }}';
      const inventoryValueLabels = {{ inventory_value_category_labels|default:'[]'|safe }};
      const inventoryValueValues = {{ inventory_value_category_values|default:'[]'|safe }};
      const inventoryValueCodes = {{ inventory_value_category_codes|default:'[]'|safe }};
      const inventoryValueMode = '{{ inventory_value_category_mode|default:"style" }}';
      const inventoryValueStyle = '{{ inventory_value_category_style|default:"" }}';
      const salesValueLabels = {{ sales_value_category_labels|default:'[]'|safe }};
      const salesValueValues = {{ sales_value_category_values|default:'[]'|safe }};
      const salesValueCodes = {{ sales_value_category_codes|default:'[]'|safe }};
      const salesValueMode = '{{ sales_value_category_mode|default:"style" }}';
      const salesValueStyle = '{{ sales_value_category_style|default:"" }}';

      const STYLE_CATEGORY_COLORS = {
        gi: '#42a5f5',
        ng: '#ab47bc',
        ap: '#66bb6a',
        ac: '#ffa726',
      };

      const TYPE_COLORS = [
        '#42a5f5',
        '#ab47bc',
        '#66bb6a',
        '#ffa726',
        '#ef5350',
        '#26c6da',
        '#8d6e63',
        '#7e57c2',
        '#5c6bc0',
        '#26a69a',
      ];

      const formatCurrency = (value) =>
        `¥${Number(value || 0).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })}`;

      const selectedStyleSet = Array.isArray(selectedStyles)
        ? new Set(selectedStyles)
        : new Set();

      const categoryChartElement = document.getElementById('categoryBreakdownChart');
      if (
        categoryChartElement &&
        categoryLabels &&
        categoryLabels.length &&
        categoryValues &&
        categoryValues.length
      ) {
        const hasSelection =
          categoryBreakdownMode === 'style' && selectedStyleSet.size > 0;
        const totalCategoryUnits = categoryValues.reduce(
          (sum, value) => sum + value,
          0
        );

        const backgroundColors = categoryCodes.map((code, index) => {
          if (categoryBreakdownMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(189, 189, 189, 0.5)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        const borderColors = categoryCodes.map((code, index) => {
          if (categoryBreakdownMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(176, 190, 197, 0.8)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        new Chart(categoryChartElement.getContext('2d'), {
          type: 'pie',
          data: {
            labels: categoryLabels,
            datasets: [
              {
                data: categoryValues,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.parsed;
                    const percentage = totalCategoryUnits
                      ? ((value / totalCategoryUnits) * 100).toFixed(1)
                      : '0.0';
                    return `${context.label}: ${value} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      const inventoryValueChartElement = document.getElementById('inventoryValueChart');
      if (
        inventoryValueChartElement &&
        inventoryValueLabels &&
        inventoryValueLabels.length &&
        inventoryValueValues &&
        inventoryValueValues.length
      ) {
        const hasValueSelection =
          inventoryValueMode === 'style' && selectedStyleSet.size > 0;
        const totalInventoryValue = inventoryValueValues.reduce(
          (sum, value) => sum + Number(value || 0),
          0
        );

        const inventoryBackgroundColors = (inventoryValueCodes || []).map(
          (code, index) => {
            if (inventoryValueMode === 'style') {
              const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
              if (!hasValueSelection) return baseColor;
              return selectedStyleSet.has(code)
                ? baseColor
                : 'rgba(189, 189, 189, 0.5)';
            }

            return TYPE_COLORS[index % TYPE_COLORS.length];
          }
        );

        const inventoryBorderColors = (inventoryValueCodes || []).map(
          (code, index) => {
            if (inventoryValueMode === 'style') {
              const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
              if (!hasValueSelection) return baseColor;
              return selectedStyleSet.has(code)
                ? baseColor
                : 'rgba(176, 190, 197, 0.8)';
            }

            return TYPE_COLORS[index % TYPE_COLORS.length];
          }
        );

        new Chart(inventoryValueChartElement.getContext('2d'), {
          type: 'pie',
          data: {
            labels: inventoryValueLabels,
            datasets: [
              {
                data: inventoryValueValues,
                backgroundColor: inventoryBackgroundColors,
                borderColor: inventoryBorderColors,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.parsed;
                    const percentage = totalInventoryValue
                      ? ((value / totalInventoryValue) * 100).toFixed(1)
                      : 0;
                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      const salesCategoryChartElement = document.getElementById('salesCategoryChart');
      if (
        salesCategoryChartElement &&
        salesCategoryLabels &&
        salesCategoryLabels.length &&
        salesCategoryValues &&
        salesCategoryValues.length
      ) {
        const totalSalesUnits = salesCategoryValues.reduce(
          (sum, value) => sum + value,
          0
        );
        const salesMode = salesCategoryMode === 'type' ? 'type' : 'style';
        const hasSalesSelection = salesMode === 'style' && selectedStyleSet.size > 0;

        const salesBackgroundColors = (salesCategoryCodes || []).map((code, index) => {
          if (salesMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSalesSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(189, 189, 189, 0.5)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        const salesBorderColors = (salesCategoryCodes || []).map((code, index) => {
          if (salesMode === 'style') {
            const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
            if (!hasSalesSelection) return baseColor;
            return selectedStyleSet.has(code)
              ? baseColor
              : 'rgba(176, 190, 197, 0.8)';
          }

          const paletteColor = TYPE_COLORS[index % TYPE_COLORS.length];
          return paletteColor;
        });

        new Chart(salesCategoryChartElement.getContext('2d'), {
          type: 'pie',
          data: {
            labels: salesCategoryLabels,
            datasets: [
              {
                data: salesCategoryValues,
                backgroundColor: salesBackgroundColors,
                borderColor: salesBorderColors,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.parsed;
                    const percentage = totalSalesUnits
                      ? ((value / totalSalesUnits) * 100).toFixed(1)
                      : 0;
                    return `${context.label}: ${value} units (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      const salesValueChartElement = document.getElementById('salesValueChart');
      if (
        salesValueChartElement &&
        salesValueLabels &&
        salesValueLabels.length &&
        salesValueValues &&
        salesValueValues.length
      ) {
        const totalSalesValue = salesValueValues.reduce(
          (sum, value) => sum + Number(value || 0),
          0
        );
        const salesValueModeNormalized = salesValueMode === 'type' ? 'type' : 'style';
        const hasSalesValueSelection =
          salesValueModeNormalized === 'style' && selectedStyleSet.size > 0;

        const salesValueBackgroundColors = (salesValueCodes || []).map(
          (code, index) => {
            if (salesValueModeNormalized === 'style') {
              const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
              if (!hasSalesValueSelection) return baseColor;
              return selectedStyleSet.has(code)
                ? baseColor
                : 'rgba(189, 189, 189, 0.5)';
            }

            return TYPE_COLORS[index % TYPE_COLORS.length];
          }
        );

        const salesValueBorderColors = (salesValueCodes || []).map(
          (code, index) => {
            if (salesValueModeNormalized === 'style') {
              const baseColor = STYLE_CATEGORY_COLORS[code] || '#26a69a';
              if (!hasSalesValueSelection) return baseColor;
              return selectedStyleSet.has(code)
                ? baseColor
                : 'rgba(176, 190, 197, 0.8)';
            }

            return TYPE_COLORS[index % TYPE_COLORS.length];
          }
        );

        new Chart(salesValueChartElement.getContext('2d'), {
          type: 'pie',
          data: {
            labels: salesValueLabels,
            datasets: [
              {
                data: salesValueValues,
                backgroundColor: salesValueBackgroundColors,
                borderColor: salesValueBorderColors,
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = context.parsed;
                    const percentage = totalSalesValue
                      ? ((value / totalSalesValue) * 100).toFixed(1)
                      : 0;
                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      const sizeChartElement = document.getElementById('sizeBreakdownChart');

      if (sizeChartElement && sizeLabels && sizeLabels.length && sizeValues && sizeValues.length) {
        sizeChartElement.height = Math.max(sizeLabels.length * 28, 160);
        new Chart(sizeChartElement.getContext('2d'), {
          type: 'bar',
          data: {
            labels: sizeLabels,
            datasets: [{
              label: 'Units',
              data: sizeValues,
              backgroundColor: 'rgba(38, 166, 154, 0.5)',
              borderColor: '#26a69a',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.x} units`
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Units in stock'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Size'
                },
                ticks: { autoSkip: false }
              }
            }
          }
        });
      }

      const renderVerticalBarChart = (elementId, labels, values, categoryTitle) => {
        const el = document.getElementById(elementId);
        if (!el || !labels || !labels.length || !values || !values.length) return;

        new Chart(el.getContext('2d'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Units',
              data: values,
              backgroundColor: 'rgba(38, 166, 154, 0.5)',
              borderColor: '#26a69a',
              borderWidth: 1,
            }],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.y} units`,
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: categoryTitle },
              },
              y: {
                title: { display: true, text: 'Units in stock' },
                ticks: { autoSkip: false },
                beginAtZero: true,
              },
            },
          },
        });
      };

      renderVerticalBarChart('ageBreakdownChart', ageLabels, ageValues, 'Age');
      renderVerticalBarChart('genderBreakdownChart', genderLabels, genderValues, 'Gender');

      if (!dataPoints || !dataPoints.length || !document.getElementById('quarterlySalesChart')) {
        return;
      }

      const ctx = document.getElementById('quarterlySalesChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Units Sold',
            data: dataPoints,
            backgroundColor: 'rgba(38, 166, 154, 0.5)',
            borderColor: '#26a69a',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y} units`
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Quarter (Year/Month)'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number Sold'
              }
            }
          }
        }
      });
    })();
  </script>
{% endblock %}
