{% extends 'inventory/base.html' %}

{% block title %}Sales{% endblock %}

{% block content %}
  <div class="section">
    <h3>Sales</h3>

    <div class="card-panel filter-toolbar">
      <form method="get" novalidate class="filter-toolbar__form">
        <div class="filter-toolbar__field">
          <label for="start_date" class="active">From</label>
          <input
            type="date"
            id="start_date"
            name="start_date"
            value="{{ start_date|date:'Y-m-d' }}"
            class="browser-default"
          />
        </div>
        <div class="filter-toolbar__field">
          <label for="end_date" class="active">To</label>
          <input
            type="date"
            id="end_date"
            name="end_date"
            value="{{ end_date|date:'Y-m-d' }}"
            class="browser-default"
          />
        </div>
        <div class="filter-toolbar__actions">
          <button type="submit" class="btn-tiny waves-effect waves-light">
            Update
          </button>
        </div>
      </form>
      <div class="filter-toolbar__aside">
        <a
          href="{% url 'referrers_overview' %}{% if date_querystring %}?{{ date_querystring }}{% endif %}"
          class="filter-toolbar__link"
        >
          Referrer overview <span aria-hidden="true">→</span>
        </a>
        <a
          href="{% url 'sales_referrers' %}{% if date_querystring %}?{{ date_querystring }}{% endif %}"
          class="filter-toolbar__link"
        >
          View sales by referrer <span aria-hidden="true">→</span>
        </a>
        {% if referrers %}
          <div class="filter-toolbar__field referrer-detail-selector">
            <label for="referrerDetailSelect" class="active">Referrer detail</label>
            <select id="referrerDetailSelect" class="browser-default">
              <option value="">Select referrer…</option>
              {% for referrer in referrers %}
                <option value="{% url 'referrer_detail' referrer.id %}">
                  {{ referrer.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endif %}
      </div>
    </div>

    {% if has_sales_data %}
      <div class="card sales-summary-card z-depth-0">
        <div class="card-content">
          <p id="netSales" class="sales-summary__net blue-text">
            ¥{{ net_sales_value|floatformat:0 }}
          </p>
          <p class="sales-summary__metric grey-text text-darken-1">
            ¥{{ gross_sales_value|floatformat:0 }} gross
          </p>
          <p class="sales-summary__metric red-text text-darken-4">
            ¥{{ returns_total_value|floatformat:0 }} returns

          </p>
          <p class="sales-summary__metric grey-text text-darken-2">
            {{ items_count }} items in {{ orders_count }} orders
          </p>
        </div>
      </div>

      <div class="card-panel sales-insights-card">
        <div class="sales-insights__header">
          <div>
            <h6 class="sales-insights__title">Monthly sales snapshot</h6>
            <p class="sales-insights__subtitle grey-text text-darken-1">
              {{ insights_month_label }} ({{ insights_start|date:"M j" }}–{{ insights_end|date:"M j" }})
              {% if insights_is_current %}
                · Current month
              {% else %}
                · Previous month
              {% endif %}
            </p>
          </div>
        </div>

        {% if insights_has_data %}
          <div class="sales-insights__grid">
            <div class="sales-insights__panel">
              <h6 class="sales-insights__panel-title">Top selling products</h6>
              <table class="striped sales-insights-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="right-align">Items</th>
                    <th class="right-align">Value</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in top_products %}
                    <tr>
                      <td>{{ row.variant__product__product_name }}</td>
                      <td class="right-align">{{ row.net_quantity }}</td>
                      <td class="right-align">¥{{ row.net_value|floatformat:2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="sales-insights__panel sales-insights__panel--chart">
              <div class="sales-insights__chart-block">
                <h6 class="sales-insights__panel-title">Category mix</h6>
                <div class="sales-insights__chart">
                  <canvas id="salesCategoryChart" aria-label="Sales by category pie chart"></canvas>
                </div>
              </div>
              <div class="sales-insights__chart-block">
                <h6 class="sales-insights__panel-title">Group mix</h6>
                <div class="sales-insights__chart">
                  <canvas id="salesGroupChart" aria-label="Sales by group pie chart"></canvas>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <p class="grey-text text-darken-1 sales-insights__empty">
            No sales recorded for this month.
          </p>
        {% endif %}
      </div>

      <div class="card-panel blue lighten-5 pricing-breakdown-card">
        <h6 class="pricing-breakdown-card__title grey-text text-darken-2">Pricing breakdown</h6>
        <p class="pricing-breakdown-card__note grey-text text-darken-1">
          Counts and totals exclude returned sales and lines with zero quantity.
        </p>
        <table class="striped pricing-breakdown-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Items sold</th>
              <th>Retail value</th>
              <th>Actual value</th>
              <th>% of sales</th>
            </tr>
          </thead>
          <tbody>
            {% for bucket in price_breakdown %}
              {% url 'sales_bucket_detail' bucket.key as bucket_url %}
              <tr
                class="clickable-row"
                data-href="{{ bucket_url }}{% if date_querystring %}?{{ date_querystring }}{% endif %}"
              >
                <td>
                  <a
                    href="{{ bucket_url }}{% if date_querystring %}?{{ date_querystring }}{% endif %}"
                    class="price-breakdown-link"
                  >
                    {{ bucket.label }}
                  </a>
                </td>
                <td>{{ bucket.items_count }}</td>
                <td>¥{{ bucket.retail_value|floatformat:2 }}</td>
                <td>¥{{ bucket.actual_value|floatformat:2 }}</td>
                <td>{{ bucket.actual_percentage|floatformat:2 }}%</td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th>{{ pricing_total_items }}</th>
              <th>¥{{ pricing_total_retail_value|floatformat:2 }}</th>
              <th>¥{{ pricing_total_actual_value|floatformat:2 }}</th>
              <th>
                {% if pricing_total_actual_value %}
                  100%
                {% else %}
                  &mdash;
                {% endif %}
              </th>
            </tr>
          </tfoot>
        </table>
      </div>
    {% else %}
      <p class="grey-text text-darken-1 no-data-message">
        No sales recorded for this date range.
      </p>
    {% endif %}
  </div>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document
        .querySelectorAll(".pricing-breakdown-table tr.clickable-row")
        .forEach(function (row) {
          row.setAttribute("tabindex", "0");
          row.addEventListener("click", function (event) {
            if (event.target.tagName && event.target.tagName.toLowerCase() === "a") {
              return;
            }
            const anchor = row.querySelector("a.price-breakdown-link");
            if (anchor) {
              window.location.href = anchor.getAttribute("href");
            }
          });
          row.addEventListener("keyup", function (event) {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              const anchor = row.querySelector("a.price-breakdown-link");
              if (anchor) {
                anchor.click();
              }
            }
          });
        });

      const referrerDetailSelect = document.getElementById("referrerDetailSelect");
      if (referrerDetailSelect) {
        const dateQuerystring = "{{ date_querystring|default:''|escapejs }}";
        referrerDetailSelect.addEventListener("change", function () {
          const selectedUrl = referrerDetailSelect.value;
          if (!selectedUrl) {
            return;
          }

          let target = selectedUrl;
          if (dateQuerystring) {
            target += selectedUrl.includes("?") ? "&" : "?";
            target += dateQuerystring;
          }
          window.location.href = target;
        });
      }

      const categoryChartEl = document.getElementById("salesCategoryChart");
      if (categoryChartEl) {
        const categoryChart = new Chart(categoryChartEl.getContext("2d"), {
          type: "pie",
          data: {
            labels: JSON.parse('{{ category_chart_labels|escapejs }}'),
            datasets: [
              {
                data: JSON.parse('{{ category_chart_values|escapejs }}'),
                backgroundColor: JSON.parse('{{ category_chart_colors|escapejs }}'),
                borderColor: "#ffffff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  boxWidth: 12,
                  padding: 16,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return context.label + ": " + context.parsed + " items";
                  },
                },
              },
            },
          },
        });
      }

      const groupChartEl = document.getElementById("salesGroupChart");
      if (groupChartEl) {
        const groupLabels = JSON.parse('{{ group_chart_labels|escapejs }}');
        const groupValues = JSON.parse('{{ group_chart_values|escapejs }}');
        const groupColors = JSON.parse('{{ group_chart_colors|escapejs }}');
        const groupChart = new Chart(groupChartEl.getContext("2d"), {
          type: "pie",
          data: {
            labels: groupLabels,
            datasets: [
              {
                data: groupValues,
                backgroundColor: groupValues.map(
                  (_value, index) => groupColors[index % groupColors.length]
                ),
                borderColor: "#ffffff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  boxWidth: 12,
                  padding: 16,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return context.label + ": " + context.parsed + " items";
                  },
                },
              },
            },
          },
        });
      }
    });
  </script>
{% endblock %}
