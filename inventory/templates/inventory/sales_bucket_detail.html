{% extends 'inventory/base.html' %}

{% block title %}{{ bucket_label }} Sales{% endblock %}

{% block content %}
<div class="section">

  <a
    href="{% url 'sales' %}{% if date_querystring %}?{{ date_querystring }}{% endif %}"
    class="btn-flat waves-effect"
  >
    ← Back to sales overview
  </a>


  <div class="card">
    <div class="card-content">
      <span class="card-title">{{ bucket_label }} sales from {{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}</span>

      <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">

        <div class="grey lighten-4" style="padding: 0.75rem 1rem; border-radius: 6px;">
          <strong>{{ orders_count }}</strong> order{{ orders_count|pluralize }} ·
          <strong>{{ bucket_totals.items_count }}</strong> item{{ bucket_totals.items_count|pluralize }} ·
          Retail: ¥{{ bucket_totals.retail_value|floatformat:2 }} ·
          Actual: ¥{{ bucket_totals.actual_value|floatformat:2 }}
          {% if bucket_totals.returns_value %}
            · <span class="red-text text-darken-1">Returns: ¥{{ bucket_totals.returns_value|floatformat:2 }}</span>
          {% endif %}
        </div>
      </div>

      {% if orders %}
        {% for order in orders %}
          <div class="order-block z-depth-1">
            <div class="order-header">
              <div>
                <span class="order-number">Order {{ order.order_number }}</span>
                <span class="order-date">· {{ order.date|date:"F j, Y" }}</span>
              </div>
            </div>

            <div class="order-referrer">
              {% if order.referrer %}
                <span class="chip teal lighten-5 teal-text text-darken-3">
                  Referrer: {{ order.referrer.name }}
                </span>
              {% endif %}
              <a
                href="#referrer-modal-{{ forloop.counter }}"
                class="modal-trigger assign-referrer-link"
              >
                Assign referrer +
              </a>
            </div>

            <div class="order-referrer">
              {% if order.referrer %}
                <span class="chip teal lighten-5 teal-text text-darken-3">
                  Referrer: {{ order.referrer.name }}
                </span>
              {% endif %}
              <a
                href="#referrer-modal-{{ forloop.counter }}"
                class="modal-trigger assign-referrer-link"
              >
                Assign referrer +
              </a>
            </div>

            <table class="highlight order-items-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th></th>
                  <th></th>
                  <th>Retail price</th>
                  <th>Actual price paid</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items %}
                  <tr>
                    <td>
                      <div class="order-item-product">
                        {% if item.sale.variant.product.product_photo %}
                          <img
                            src="{{ item.sale.variant.product.product_photo.url }}"
                            alt="{{ item.sale.variant.product.product_name }}"
                          />
                        {% else %}
                          <div class="order-item-placeholder">No photo</div>
                        {% endif %}
                        <div>
                          <div class="variant-code">{{ item.sale.variant.variant_code }}</div>
                          <div class="quantity grey-text text-darken-1">Qty: {{ item.sold_quantity }}</div>
                          {% if not item.is_bucket_item %}
                            <div class="order-item-badge grey lighten-3 grey-text text-darken-2">
                              Outside {{ bucket_label }}
                            </div>
                          {% endif %}
                        </div>

                      </div>
                    </td>
                    <td>{{ item.sale.variant.variant_code }}</td>
                    <td>x{{ item.sold_quantity }}</td>
                    <td>
                      ¥{{ item.retail_price|floatformat:2 }}
                      <div class="grey-text text-darken-1">each</div>
                    </td>
                    <td>
                      ¥{{ item.actual_unit_price|floatformat:2 }}
                      <div class="grey-text text-darken-1">
                        Total: ¥{{ item.actual_total|floatformat:2 }}
                      </div>
                    </td>
                    <td>
                      {% if item.returned %}
                        <span class="red-text text-darken-1">Returned</span>
                      {% else %}
                        &mdash;
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td><strong>TOTAL</strong></td>
                  <td>
                    <div class="order-values">
                      <span class="order-total">¥{{ order.total_value|floatformat:2 }}</span>
                      {% if order.returns_value %}
                        <span class="order-returns red-text text-darken-1">Returns: ¥{{ order.returns_value|floatformat:2 }}</span>
                      {% endif %}
                    </div>
                  </td>
                  <td></td>
                </tr>
              </tbody>
            </table>
            <div id="referrer-modal-{{ forloop.counter }}" class="modal">
              <form method="post" action="{% url 'assign_order_referrer' bucket_key=bucket_key %}">
                {% csrf_token %}
                <input type="hidden" name="order_number" value="{{ order.order_number }}" />
                {% if date_querystring %}
                  <input type="hidden" name="date_querystring" value="{{ date_querystring }}" />
                {% endif %}
                <div class="modal-content">
                  <h4>Assign referrer</h4>
                  {% if referrers %}
                    <div class="input-field">
                      <select name="referrer_id" class="referrer-select">
                        <option value="" {% if not order.referrer %}selected{% endif %}>No referrer</option>
                        {% for referrer in referrers %}
                          <option
                            value="{{ referrer.id }}"
                            {% if order.referrer and order.referrer.id == referrer.id %}selected{% endif %}
                          >
                            {{ referrer.name }}
                          </option>
                        {% endfor %}
                      </select>
                      <label>Select a referrer</label>
                    </div>
                  {% else %}
                    <p class="grey-text text-darken-1" style="margin-bottom: 0;">
                      No referrers available yet. Add one from the admin to get started.
                    </p>
                  {% endif %}
                </div>
                <div class="modal-footer">
                  <button
                    type="submit"
                    class="btn waves-effect waves-light"
                    {% if not referrers %}disabled{% endif %}
                  >
                    Save
                  </button>
                  <a href="#!" class="modal-close btn-flat">Cancel</a>
                </div>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="grey-text text-darken-1" style="margin-top: 2rem;">
          No sales matched this pricing group for the selected date range.
        </p>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .order-block {
    background-color: #ffffff;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    padding: 1.25rem;
  }

  .order-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .order-number {
    font-weight: 600;
  }

  .order-values {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .order-referrer {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .assign-referrer-link {
    color: #00897b;
    font-weight: 600;
    text-decoration: none;
  }

  .assign-referrer-link:hover {
    text-decoration: underline;
  }

  .order-items-table th,
  .order-items-table td {
    vertical-align: middle;
  }

  .order-item-product {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .order-item-badge {
    border-radius: 12px;
    display: inline-block;
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 0.3rem;
    padding: 0.2rem 0.6rem;
  }

  .order-item-product img {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
  }

  .order-item-placeholder {
    align-items: center;
    background-color: #e0e0e0;
    border-radius: 6px;
    color: #616161;
    display: flex;
    font-size: 0.8rem;
    height: 64px;
    justify-content: center;
    width: 64px;
  }

  .variant-code {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
</style>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var modalElems = document.querySelectorAll('.modal');
      M.Modal.init(modalElems);

      var selectElems = document.querySelectorAll('select.referrer-select');
      M.FormSelect.init(selectElems);
    });
  </script>
{% endblock %}
