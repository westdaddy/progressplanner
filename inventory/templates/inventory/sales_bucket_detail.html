{% extends 'inventory/base.html' %}

{% block title %}{{ bucket_label }} Sales{% endblock %}

{% block content %}
  <div class="section">
    <h3>
      Sales
      <span class="grey-text small">
        | {{ bucket_label }} sales from {{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}
      </span>
    </h3>

    <div class="card-panel grey lighten-4 page-summary">
      <div class="page-summary__primary">
        <a
          href="{% url 'sales' %}{% if date_querystring %}?{{ date_querystring }}{% endif %}"
          class="page-summary__back-link"
        >
          ← Back to sales overview
        </a>
      </div>
      <div class="page-summary__stats">
        <span class="page-summary__stat">
          <strong>{{ orders_count }}</strong> order{{ orders_count|pluralize }}
        </span>
        <span class="page-summary__stat">
          <strong>{{ bucket_totals.items_count }}</strong> item{{ bucket_totals.items_count|pluralize }}
        </span>
        <span class="page-summary__stat">Retail: ¥{{ bucket_totals.retail_value|floatformat:2 }}</span>
        <span class="page-summary__stat">Actual: ¥{{ bucket_totals.actual_value|floatformat:2 }}</span>
        {% if bucket_totals.returns_value %}
          <span class="page-summary__stat red-text text-darken-1">
            &minus;¥{{ bucket_totals.returns_value|floatformat:2 }}
          </span>
        {% endif %}
      </div>
    </div>

    {% if orders %}
      {% for order in orders %}
        <div class="order-block">
          <div class="order-header">
            <div class="left">
              <span class="order-number">#{{ order.order_number }}</span>
              <span class="order-date">· {{ order.date|date:"F j, Y" }}</span>
            </div>

            <div class="right">
              <div class="order-referrer">
                {% if order.referrer %}
                  <span class="chip teal lighten-5 teal-text text-darken-3">
                    Referrer: {{ order.referrer.name }}
                    <a
                      href="#referrer-modal-{{ forloop.counter }}"
                      class="modal-trigger assign-referrer-link"
                    >
                      <i class="material-icons tiny">edit</i>
                    </a>
                  </span>
                {% else %}
                  <a
                    href="#referrer-modal-{{ forloop.counter }}"
                    class="chip white modal-trigger assign-referrer-link"
                  >
                    Assign referrer +
                  </a>
                {% endif %}
              </div>
            </div>
          </div>

          <table class="highlight order-items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th></th>
                <th>Original price</th>
                <th>Actual price</th>
                <th>Total paid</th>
                <th>Refunded</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order.items %}
                <tr class="{% if not item.is_bucket_item %}grey-text text-lighten-1{% endif %}">
                  <td>
                    <div class="order-item-product">
                      {% if item.sale.variant.product.product_photo %}
                        <img
                          src="{{ item.sale.variant.product.product_photo.url }}"
                          alt="{{ item.sale.variant.product.product_name }}"
                        />
                      {% else %}
                        <div class="order-item-placeholder">No photo</div>
                      {% endif %}
                      <div>
                        <div class="variant-code">
                          {{ item.sale.variant.variant_code }}
                          <a
                            href="{% url 'admin:inventory_sale_change' item.sale.pk %}"
                            class="variant-edit-link"
                            target="_blank"
                            rel="noopener"
                            title="Edit sale in admin"
                            aria-label="Edit sale {{ item.sale.sale_id }} in admin"
                          >
                            <i class="material-icons tiny">edit</i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>x{{ item.sold_quantity }}</td>
                  <td>¥{{ item.retail_price|floatformat:2 }}</td>
                  <td>
                    <div class="price-with-discount">
                      <span class="actual-price">¥{{ item.actual_unit_price|floatformat:2 }}</span>
                      {% if item.discount_percentage is not None %}
                        <span class="discount-percentage grey-text text-darken-1">
                          -{{ item.discount_percentage|floatformat:-1 }}%
                        </span>
                      {% endif %}
                    </div>
                  </td>
                  <td>¥{{ item.actual_total|floatformat:2 }}</td>
                  <td>
                    {% if item.return_value %}
                      <span class="red-text text-darken-2">¥{{ item.return_value|floatformat:2 }} (x{{ item.return_quantity }})</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if item.returned %}
                      <span class="chip return-chip red lighten-5 red-text text-darken-2">Returned</span>
                    {% else %}
                      &mdash;
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td><strong>TOTAL</strong></td>
                <td>
                  <div class="order-values">
                    <span class="order-total">¥{{ order.total_value|floatformat:2 }}</span>
                  </div>
                </td>
                <td>
                  {% if order.returns_value %}
                    <span class="order-returns red-text text-darken-1">-¥{{ order.returns_value|floatformat:2 }}</span>
                  {% endif %}
                </td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <div id="referrer-modal-{{ forloop.counter }}" class="modal">
            <form method="post" action="{% url 'assign_order_referrer' bucket_key=bucket_key %}">
              {% csrf_token %}
              <input type="hidden" name="order_number" value="{{ order.order_number }}" />
              {% if date_querystring %}
                <input type="hidden" name="date_querystring" value="{{ date_querystring }}" />
              {% endif %}
              <div class="modal-content">
                <h4>Assign referrer</h4>
                <input
                  type="hidden"
                  name="referrer_id"
                  value="{% if order.referrer %}{{ order.referrer.id }}{% endif %}"
                />
                {% if referrers %}
                  <p class="grey-text text-darken-1 modal-helper-text">
                    Select a referrer below.
                  </p>
                {% else %}
                  <p class="grey-text text-darken-1 modal-helper-text">
                    No referrers available yet. Add one from the admin to get started.
                  </p>
                {% endif %}
                <div class="referrer-chip-group">
                  <div
                    class="chip referrer-chip {% if not order.referrer %}selected{% endif %}"
                    data-referrer-id=""
                    tabindex="0"
                  >
                    No referrer
                  </div>
                  {% for referrer in referrers %}
                    <div
                      class="chip referrer-chip {% if order.referrer and order.referrer.id == referrer.id %}selected{% endif %}"
                      data-referrer-id="{{ referrer.id }}"
                      tabindex="0"
                    >
                      {{ referrer.name }}
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="submit"
                  class="btn waves-effect waves-light"
                >
                  Save
                </button>
                <a href="#!" class="modal-close btn-flat">Cancel</a>
              </div>
            </form>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="grey-text text-darken-1 no-data-message">
        No sales matched this pricing group for the selected date range.
      </p>
    {% endif %}
  </div>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var modalElems = document.querySelectorAll('.modal');
      M.Modal.init(modalElems);

      var chipGroups = document.querySelectorAll('.referrer-chip-group');
      chipGroups.forEach(function(group) {
        var chips = group.querySelectorAll('.referrer-chip');
        if (!chips.length) {
          return;
        }

        var form = group.closest('form');
        if (!form) {
          return;
        }

        var hiddenInput = form.querySelector('input[name="referrer_id"]');
        var setActiveChip = function(targetChip) {
          chips.forEach(function(chip) {
            chip.classList.remove('selected');
          });

          targetChip.classList.add('selected');

          if (hiddenInput) {
            hiddenInput.value = targetChip.dataset.referrerId || '';
          }
        };

        chips.forEach(function(chip) {
          chip.addEventListener('click', function() {
            setActiveChip(chip);
          });

          chip.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              setActiveChip(chip);
            }
          });
        });
      });
    });
  </script>
{% endblock %}
