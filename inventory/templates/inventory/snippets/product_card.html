


<ul class="collection">
  <li class="collection-item avatar lighten-4 {% if product.total_sales|default:0 == 0 and product.total_inventory|default:0 == 0 %}new{% endif %}">

      <div class="row item">

        <div class="col s12 content">
          <div class="row title">
            <div class="col s12">
              <span class="title">
                <a href="{% url 'product_detail' product.id %}">
                  <strong>{{ product.product_name }}</strong>
                </a>
              </span>
              ({{ product.product_id }})
            </div>
          </div>

          <div class="row scorecard-boxes">

            <div class="col s12 m6 l2 photo">
              {% if product.product_photo %}
                <img src="{{ product.product_photo.url }}" alt="{{ product.product_name }}" class="circle product-photo-large">
              {% else %}
                <img src="{{ MEDIA_URL }}product_photos/product-placeholder.jpg" alt="{{ product.product_name }}" class="circle product-photo-large">
              {% endif %}
            </div>

            <div class="col s12 m6 l3">
              <div class="card-panel scorecard-box">
              {% if product.total_inventory|default:0 == 0 and product.last_order_qty|default:0 == 0 %}
                <span><strong>New product</strong></span><br/>
                <span class="grey-text">No stock or order history yet.</span><br/>
                <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                  <button
                    type="button"
                    class="btn teal lighten-1"
                    data-open-order-modal="order-modal-{{ product.id }}"
                    data-order-mode="create"
                  >
                    Create order
                  </button>
                  {% if product.pending_order %}
                    <button
                      type="button"
                      class="btn blue-grey lighten-1"
                      data-open-order-modal="order-modal-{{ product.id }}"
                      data-order-mode="pending"
                    >
                      View pending order
                    </button>
                  {% endif %}
                </div>
              {% else %}
                <span>
                  Current stock:
                  <strong>{{ product.total_inventory|default:0 }}</strong>
                </span><br/>
                <span>
                  Projected sell-out:
                  {% if product.projected_sell_out_date %}
                    <strong>{{ product.projected_sell_out_date|date:"M j, Y" }}</strong>
                  {% else %}
                    —
                  {% endif %}
                </span><br/>
                {% if product.low_stock_skus %}
                  <span>
                    Low stock SKUs:
                    <strong>{{ product.low_stock_skus|join:" / " }}</strong>
                  </span><br/>
                {% endif %}
                {% if product.out_of_stock_skus %}
                  <span>
                    Out of stock SKUs:
                    <strong>{{ product.out_of_stock_skus|join:" / " }}</strong>
                  </span>
                {% endif %}
                <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                  <button
                    type="button"
                    class="btn teal lighten-1"
                    data-open-order-modal="order-modal-{{ product.id }}"
                    data-order-mode="create"
                  >
                    {% if product.last_order_qty %}Create reorder{% else %}Create order{% endif %}
                  </button>
                  {% if product.pending_order %}
                    <button
                      type="button"
                      class="btn blue-grey lighten-1"
                      data-open-order-modal="order-modal-{{ product.id }}"
                      data-order-mode="pending"
                    >
                      View pending order
                    </button>
                  {% endif %}
                </div>
              {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>
    </li>
  </ul>

  <div
    class="product-order-modal"
    id="order-modal-{{ product.id }}"
    aria-hidden="true"
    data-product-id="{{ product.id }}"
    data-pending-order-id="{{ product.pending_order.order_id|default:'' }}"
    data-pending-order-expected="{{ product.pending_order.expected_date|date:'Y-m-d' }}"
    data-pending-order-cost="{{ product.pending_order.item_cost_price|default:'' }}"
    data-pending-order-total="{{ product.pending_order.total_quantity|default:'' }}"
    data-pending-order-unassigned="{% if product.pending_order and product.pending_order.unassigned %}true{% endif %}"
  >
    <div class="product-order-modal__backdrop" data-close-order-modal></div>
    <div class="product-order-modal__content">
      <div class="product-order-modal__header">
        <h5>{{ product.product_name }}</h5>
        <button type="button" class="btn-flat" data-close-order-modal>&times;</button>
      </div>
      <div class="product-order-modal__body">
        <form
          method="post"
          class="product-order-form"
          data-order-form
          data-create-action="{% url 'order_item_create' %}"
          data-update-action="{% url 'order_item_update' %}"
          style="width: 100%;"
        >
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <input type="hidden" name="pending_order_id" value="" data-pending-order-id>
          <input type="hidden" name="pending_order_unassigned" value="" data-pending-unassigned>
        <div class="product-order-modal__media">
          {% if product.product_photo %}
            <img src="{{ product.product_photo.url }}" alt="{{ product.product_name }}">
          {% else %}
            <img src="{{ MEDIA_URL }}product_photos/product-placeholder.jpg" alt="{{ product.product_name }}">
          {% endif %}
        </div>
        <div class="product-order-modal__table">
          <div class="row" style="margin: 0 0 8px;">
            <div class="input-field col s12 m6" style="margin-top: 0;">
              <input
                type="date"
                name="date_expected"
                data-expected-date-input
                required
              >
              <label>Expected arrival date</label>
            </div>
            <div class="input-field col s12 m6" style="margin-top: 0;">
              <input
                type="number"
                min="0"
                step="0.01"
                name="item_cost_price"
                data-item-cost-input
                required
              >
              <label>Item cost price (CNY)</label>
            </div>
          </div>
          <div class="input-field" style="margin-top: 0;">
            <input
              type="number"
              min="0"
              class="total-order-input"
              data-total-order-input
              placeholder="0"
            >
            <label>Total order quantity</label>
          </div>
          {% if product.reorder_summary %}
            <div class="card-panel teal lighten-5" style="margin: 0 0 12px;">
              <strong>Suggested reorder:</strong>
              {{ product.reorder_summary.suggested_total }} units
              <span class="grey-text text-darken-1">
                (6 months, includes {{ product.reorder_summary.on_order_total }} on order)
              </span>
              <br>
              <span class="grey-text text-darken-1">
                Demand: {{ product.reorder_summary.speed_12 }}/mo ·
                Recent: {{ product.reorder_summary.speed_3 }}/mo ·
                Confidence: {{ product.reorder_summary.confidence|capfirst }}
              </span>
            </div>
          {% endif %}
          {% if product.restock_recommendations %}
            <div class="card-panel blue-grey lighten-5" style="margin: 0 0 12px;">
              <strong>Restock recommendations:</strong>
              <ul style="margin: 8px 0 0; padding-left: 18px;">
                {% for rec in product.restock_recommendations %}
                  <li>{{ rec.message }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <table class="striped">
            <thead>
              <tr>
                <th>Size</th>
                <th>SKU</th>
                <th>Order Qty</th>
              </tr>
            </thead>
            <tbody>
              {% for variant in product.variants_with_inventory %}
                <tr>
                  <td>{{ variant.size|default:"—" }}</td>
                  <td>{{ variant.variant_code }}</td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      placeholder="0"
                      name="variant_{{ variant.id }}"
                      data-order-qty-input
                      data-size="{{ variant.size|default:'' }}"
                      data-size-share="{{ variant.size_sales_share|default:0 }}"
                      data-pending-qty="{{ variant.pending_order_qty|default:0 }}"
                    >
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="grey-text">No variants available.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <div style="margin-top: 16px; text-align: right;">
            <button type="submit" class="btn teal lighten-1">Save order</button>
          </div>
        </div>
        </form>
      </div>
    </div>
  </div>
