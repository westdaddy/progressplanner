{% extends 'inventory/base.html' %}

{% block title %}Home{% endblock %}

{% block content %}

<div class="section">
  <div class="row">

    <!-- SALES LINE CHART -->
    <div class="col s12">
      <div class="card z-depth-2" style="overflow: hidden;">

          <!-- Top: Line Chart with colored background -->
          <div class="card-content cyan darken-2 white-text" style="padding: 0;">
            <div style="padding: 20px;">
              <span>Sales Revenue - {{ current_month_name }}</span>
              <canvas id="monthlySalesChart" style="width: 100%; height: 250px;"></canvas>
            </div>
          </div>
      </div>
    </div>


    <!-- SALES INFORMATION SECTION -->
    <div class="col s12">
      <div id="sales-info-card" class="card z-depth-2" style="overflow: hidden; position: relative;">
        <a href="#" id="prevMonth" class="month-arrow" style="position:absolute; left:0; top:50%; transform:translate(-50%,-50%);">
          <i class="material-icons">chevron_left</i>
        </a>
        <a href="#" id="nextMonth" class="month-arrow" style="position:absolute; right:0; top:50%; transform:translate(50%,-50%);">
          <i class="material-icons">chevron_right</i>
        </a>

          <!-- Bottom: White section with donut chart + legend -->
          <div class="card-content white">
            <h6 id="salesMonthLabel" class="center-align">{{ current_month_name }}</h6>
            <div class="row" style="margin: 0;">

              <!-- Left: Donut Chart (1/3) -->
              <div class="col s12 m2">
                <div style="position: relative; width: 150px; height: 150px;">
                  <canvas id="categoryDonutChart" width="150" height="150"></canvas>
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <span id="totalItemsSold" style="font-size: 1.4rem; font-weight: bold;">{{ total_items_sold }}</span><br>
                    <span style="font-size: 0.9rem;">Items Sold</span>
                  </div>
                </div>
              </div>

            <!-- Custom Legend -->
            <div class="col s12 m2" style="position: relative; height: 150px;">

                <ul class="" style="list-style: none; padding-left: 0; margin-top:30px;">
                  <li><span style="background:#43a047; display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px;"></span>Gi</li>
                  <li><span style="background:#1e88e5; display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px;"></span>Rashguard</li>
                  <li><span style="background:#fb8c00; display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px;"></span>Shorts</li>
                  <li><span style="background:#9e9e9e; display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px;"></span>Other</li>
                </ul>
            </div>

              <!-- Right: Summary Cards (2/3) -->
              <div class="col s12 m8">
                <div class="row" style="margin: 0;">
                  <!-- Sales -->
                  <div class="col s4 m4 l4">
                    <div class="card green lighten-2 z-depth-1" style="margin-bottom: 10px;">
                      <div class="card-content white-text center-align">
                        <span class="green-text text-darken-4"  style="font-size: 1.1rem; font-weight: 600;">Gross Sales</span>
                        <h5 id="totalSales" style="margin: 0px; font-weight: 500;">¥{{ total_sales|floatformat:0 }}</h5>
                      </div>
                      <div class="green lighten-1 center-align" style="padding: 8px; ">
                        <a href="#" class="white-text" style="font-weight: 500;">View Details</a>
                      </div>
                    </div>
                  </div>

                  <!-- Returns -->
                  <div class="col s4 m4 l4">
                    <div class="card red lighten-2 z-depth-1" style="margin-bottom: 10px;">
                      <div class="card-content white-text center-align">
                        <span class="red-text text-darken-4" style="font-size: 1.1rem; font-weight: 600;">Returns</span>
                        <h5 id="totalReturns" style="margin: 0px; font-weight: 500;">¥{{ total_returns|floatformat:0 }}</h5>
                      </div>
                      <div class="red lighten-1 center-align" style="padding: 8px; ">
                        <a href="{% url 'returns' %}" class="white-text" style="font-weight: 500;">View Details</a>
                      </div>
                    </div>
                  </div>

                  <!-- Net Sales -->
                  <div class="col s4 m4 l4">
                    <div class="card blue lighten-2 z-depth-1">
                      <div class="card-content white-text center-align">
                        <span class="blue-text text-darken-4" style="font-size: 1.1rem; font-weight: 600;">Net Sales</span>
                        <h5 id="netSales" style="margin: 0px; font-weight: 500;">¥{{ net_sales|floatformat:0 }}</h5>
                      </div>
                      <div class="blue lighten-1 center-align" style="padding: 8px; ">
                        <a href="#" class="white-text" style="font-weight: 500;">View Details</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div> <!-- end of card content -->

      </div>
    </div> <!-- end of col s12 -->


    <!-- INVENTORY SECTION -->
    <p id="snapshotWarning" class="red-text center-align" style="{% if not snapshot_warning %}display:none;{% endif %}">
      Inventory snapshot from <span id="snapshotDate">{{ snapshot_date }}</span> may not reflect end-of-month.
    </p>
      <div class="col s12 m6 l6">
        <div class="card teal lighten-2 z-depth-1">
          <div class="card-content white-text center-align">
            <span class="teal-text text-darken-4" style="font-size: 1.1rem; font-weight: 600;">Inventory</span>
            <h5 id="inventoryCount" style="margin: 0px; font-weight: 500;">{{ inventory_count }} items</h5>
            <span id="inventoryValue" class="details teal-text text-darken-2">cost value ¥{{ inventory_value|floatformat:0 }}</span><br/>
            <span id="onPaperValue" class="details green-text text-darken-2">on paper value ¥{{ on_paper_value|floatformat:0 }}</span><br/>
            <span id="estimatedInventorySalesValue" class="details pink-text text-darken-2">estimated sales value ¥{{ estimated_inventory_sales_value|floatformat:0 }}</span>
        </div>
        <div class="teal darken-1 center-align" style="padding: 8px;">
          <a href="{% url 'inventory_snapshots' %}"
             class="white-text"
             style="font-weight:500;">
            View Inventory
          </a>
        </div>


      </div>
    </div>

      <div class="col s12 m6 l6">
        <div class="card pink lighten-2 z-depth-1">

          <div class="card-content white-text center-align">
            <span class="pink-text text-darken-4" style="font-size: 1.1rem; font-weight: 600;">On Order</span>
            <h5 id="onOrderCount" style="margin: 0px; font-weight: 500;">{{ on_order_count }} items</h5>
            <span id="onOrderValue" class="details pink-text text-darken-2">cost value ¥{{ on_order_value|floatformat:0 }}</span><br/>
            <span id="onOrderPaperValue" class="details green-text text-darken-2">on paper value ¥{{ on_order_on_paper_value|floatformat:0 }}</span><br/>
            <span id="estimatedOnOrderSalesValue" class="details teal-text text-darken-2">estimated sales value ¥{{ estimated_on_order_sales_value|floatformat:0 }}</span>

          </div>

          <div class="pink darken-1 center-align" style="padding: 8px;">
            <a href="{% url 'order_list' %}"
               class="white-text"
               style="font-weight:500;">
              View Orders
            </a>
          </div>


        </div>
      </div>

  </div>
</div>





{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  var ctx = document.getElementById("monthlySalesChart").getContext("2d");

  var monthlySalesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: JSON.parse('{{ monthly_labels|escapejs }}'),
      datasets: [
        {
          label: "Sales per Month (Value)",
          data: JSON.parse('{{ monthly_sales|escapejs }}'),
          backgroundColor: "rgba(190, 251, 244, 0.2)",
          borderColor: "rgba(190, 251, 244, 1)",
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointBackgroundColor: "rgba(75, 192, 192, 1)",
          pointBorderColor: "#fff",
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: "Sales Last Year",
          data: JSON.parse('{{ monthly_sales_last_year|escapejs }}'),
          backgroundColor: "rgba(255, 255, 255, 0)",  // no fill
          borderColor: "rgba(255, 255, 255, 0.5)",
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          borderDash: [5, 5],
          pointBackgroundColor: "rgba(255, 255, 255, 0.5)",
          pointBorderColor: "#fff",
          pointRadius: 3,
          pointHoverRadius: 5
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          labels: { color: 'white' }
        },
        title: {
          display: false,
          text: 'Sales per Month (Last 12 Months)'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              return context.dataset.label + ': ¥' + value.toLocaleString();
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: 'white' },
          title: { display: false, text: 'Month', color: 'white' }
        },
        y: {
          ticks: {
            color: 'white',
            callback: function(value, index, values) {
              return value >= 1000 ? (value / 1000) + 'k' : value;
            }
          },
          title: { display: false, text: 'Sales Value (¥)', color: 'white' },
          beginAtZero: true
        }
      }
    }
  });
});
</script>



<script>
  const donutCtx = document.getElementById('categoryDonutChart').getContext('2d');
  var donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: {
      labels: {{ category_labels|safe }},
      datasets: [{
        data: {{ category_values|safe }},
        backgroundColor: {{ category_colors|safe }},
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + ' items';
            }
          }
        }
      }
    }
  });

  let currentMonth = '{{ current_month_slug }}';

  function updateSalesSection(data) {
    document.getElementById('salesMonthLabel').textContent = data.month_label;
    document.getElementById('totalItemsSold').textContent = data.total_items_sold;
    document.getElementById('totalSales').textContent = '¥' + Math.round(data.total_sales).toLocaleString();
    document.getElementById('totalReturns').textContent = '¥' + Math.round(data.total_returns).toLocaleString();
    document.getElementById('netSales').textContent = '¥' + Math.round(data.net_sales).toLocaleString();

    donutChart.data.labels = data.category_labels;
    donutChart.data.datasets[0].data = data.category_values;
    donutChart.data.datasets[0].backgroundColor = data.category_colors;
    donutChart.update();
  }

  function updateInventorySection(data) {
    document.getElementById('inventoryCount').textContent = data.inventory_count + ' items';
    document.getElementById('inventoryValue').textContent = 'cost value ¥' + Math.round(data.inventory_value).toLocaleString();
    document.getElementById('onPaperValue').textContent = 'on paper value ¥' + Math.round(data.on_paper_value).toLocaleString();
    document.getElementById('estimatedInventorySalesValue').textContent = 'estimated sales value ¥' + Math.round(data.estimated_inventory_sales_value).toLocaleString();

    document.getElementById('onOrderCount').textContent = data.on_order_count + ' items';
    document.getElementById('onOrderValue').textContent = 'cost value ¥' + Math.round(data.on_order_value).toLocaleString();
    document.getElementById('onOrderPaperValue').textContent = 'on paper value ¥' + Math.round(data.on_order_on_paper_value).toLocaleString();
    document.getElementById('estimatedOnOrderSalesValue').textContent = 'estimated sales value ¥' + Math.round(data.estimated_on_order_sales_value).toLocaleString();

    const warn = document.getElementById('snapshotWarning');
    const dateEl = document.getElementById('snapshotDate');
    if (data.snapshot_warning) {
      warn.style.display = 'block';
      dateEl.textContent = data.snapshot_date;
    } else {
      warn.style.display = 'none';
    }
  }

  function fetchMonth(y, m) {
    fetch(`/sales-data/?year=${y}&month=${m}`)
      .then(r => r.json())
      .then(d => { currentMonth = d.current_month_slug; updateSalesSection(d); updateInventorySection(d); });
  }

  function adjustMonth(off) {
    const parts = currentMonth.split('-');
    let y = parseInt(parts[0]);
    let m = parseInt(parts[1]) + off;
    if (m < 1) { m = 12; y--; }
    if (m > 12) { m = 1; y++; }
    fetchMonth(y, m);
  }

  document.getElementById('prevMonth').addEventListener('click', function(e){ e.preventDefault(); adjustMonth(-1); });
  document.getElementById('nextMonth').addEventListener('click', function(e){ e.preventDefault(); adjustMonth(1); });
</script>


{% endblock %}
